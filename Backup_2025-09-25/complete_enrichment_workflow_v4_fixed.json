{
  "createdAt": "2025-09-25T08:03:13.894Z",
  "updatedAt": "2025-09-25T08:03:13.894Z",
  "id": "Doq6cC4zb2Icymxn",
  "name": "complete_enrichment_workflow_v4_fixed",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "id": "b70f5d47-6c04-459c-94a2-e00e18471fba",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        64,
        0
      ],
      "parameters": {}
    },
    {
      "id": "3a12c045-1142-4cb3-8390-551cd46c255f",
      "name": "1. Read Companies from Google Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        304,
        0
      ],
      "onError": "continueRegularOutput",
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1C9G3lFSScjY4LZ4dlnY8d0ekIxFYhE8jsYxAF2ASEtk",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "0",
          "mode": "id"
        },
        "options": {}
      },
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "ZG1MR4HwHasbUvb4",
          "name": "Cognigenai Google Sheets account"
        }
      }
    },
    {
      "id": "250b679f-e8f1-45cb-9337-8ad9cf63bb00",
      "name": "Split Companies for Processing",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        592,
        0
      ],
      "onError": "continueErrorOutput",
      "parameters": {
        "options": {}
      }
    },
    {
      "id": "525145ad-86a0-47eb-9a85-4cd8e08b6c4e",
      "name": "Extract Company Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        880,
        0
      ],
      "parameters": {
        "fields": {
          "values": [
            {
              "name": "companyName",
              "stringValue": "={{ $json.\"Account Name\" }}"
            },
            {
              "name": "country",
              "stringValue": "={{ $json.Country }}"
            },
            {
              "name": "city",
              "stringValue": "={{ $json.City }}"
            }
          ]
        },
        "include": "selected",
        "options": {}
      }
    },
    {
      "id": "050c767c-59e5-4923-be52-0ce78dc30d0b",
      "name": "2. Scrape Company Information",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        1088,
        0
      ],
      "onError": "continueErrorOutput",
      "parameters": {
        "method": "POST",
        "url": "https://google.serper.dev/search",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $json.companyName }}"
            },
            {
              "name": "gl",
              "value": "={{ $json.country === 'US - United States of America' ? 'us' : 'uk' }}"
            },
            {
              "name": "location",
              "value": "={{ $json.city && $json.country ? $json.city + ', ' + $json.country : $json.country }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "odw0FaTRUSGiHCOl",
          "name": "Serper dev Header Auth account"
        }
      }
    },
    {
      "id": "95d3d070-5182-4424-94bd-1803ca12861f",
      "name": "Extract Company Details",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        0
      ],
      "parameters": {
        "jsCode": "const input = items[0].json;\nlet company_name = \"\";\nlet website = \"\";\nlet domain = \"\";\nlet description = \"\";\nlet industry = \"\";\n\nif (input.organic && Array.isArray(input.organic)) {\n  const wikiResult = input.organic.find(r => r.link && r.link.includes(\"wikipedia.org\"));\n  if (wikiResult) {\n    description = wikiResult.snippet || description;\n  }\n  \n  const websiteResult = input.organic.find(r => r.link && r.link.includes(\".com\"));\n  if (websiteResult) {\n    website = websiteResult.link;\n    try {\n      domain = new URL(website).hostname;\n    } catch (e) {\n      domain = website;\n    }\n  }\n  \n  if (input.organic[0] && input.organic[0].title) {\n    company_name = input.organic[0].title;\n  }\n}\n\nreturn [{\n  json: {\n    company_name,\n    website,\n    domain,\n    description,\n    industry\n  }\n}];"
      }
    },
    {
      "id": "dda66ea0-549b-415d-8ce2-9e6e77553adc",
      "name": "3. Find CEO LinkedIn Profile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        1536,
        0
      ],
      "onError": "continueErrorOutput",
      "parameters": {
        "method": "POST",
        "url": "https://google.serper.dev/search",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $json.company_name }} CEO LinkedIn site:linkedin.com/in/"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "odw0FaTRUSGiHCOl",
          "name": "Serper dev Header Auth account"
        }
      }
    },
    {
      "id": "ca501997-bfe5-42d8-b9b7-bc613bf9a200",
      "name": "Extract CEO Information",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        0
      ],
      "parameters": {
        "jsCode": "const allData = [];\nfor (const item of $input.all()) {\n  const searchResults = item.json.organic || [];\n  const prevData = $('Extract Company Details').all()[0]?.json || {};\n  \n  let ceoName = '';\n  let ceoLinkedin = '';\n  let ceoTitle = '';\n\n  for (const result of searchResults) {\n    const title = result.title || '';\n    const snippet = result.snippet || '';\n    const link = result.link || '';\n    \n    if (link.includes('linkedin.com/in/')) {\n      const titleLower = title.toLowerCase();\n      const snippetLower = snippet.toLowerCase();\n      \n      if (titleLower.includes('ceo') || titleLower.includes('chief executive') ||\n          titleLower.includes('founder') || titleLower.includes('president') ||\n          snippetLower.includes('ceo') || snippetLower.includes('chief executive')) {\n        \n        const nameMatch = title.match(/^([^|\\-]+)/);\n        if (nameMatch) {\n          ceoName = nameMatch[1].trim();\n          ceoLinkedin = link;\n          \n          if (snippetLower.includes('ceo') || snippetLower.includes('chief executive officer')) {\n            ceoTitle = 'CEO';\n          } else if (snippetLower.includes('founder')) {\n            ceoTitle = 'Founder';\n          } else if (snippetLower.includes('president')) {\n            ceoTitle = 'President';\n          } else {\n            ceoTitle = 'Executive';\n          }\n          break;\n        }\n      }\n    }\n  }\n\n  allData.push({\n    ...prevData,\n    ceo_name: ceoName || 'Not found',\n    ceo_title: ceoTitle || 'Not found',\n    ceo_linkedin: ceoLinkedin || 'Not found'\n  });\n}\n\nreturn allData;"
      }
    },
    {
      "id": "4551b3b1-b10d-4b2a-8de7-ec9140927e66",
      "name": "Split CEO Name",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        0
      ],
      "parameters": {
        "jsCode": "return items.map(item => {\n  const ceoName = item.json.ceo_name || \"\";\n  const parts = ceoName.trim().split(/\\s+/);\n\n  return {\n    json: {\n      ...item.json,\n      first_name: parts[0] || \"\",\n      last_name: parts.length > 1 ? parts[parts.length - 1] : \"\"\n    }\n  };\n});"
      }
    },
    {
      "id": "20a7c659-4150-4eb7-82b1-a32890ddcb2f",
      "name": "Find CEO Email Address",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        2192,
        0
      ],
      "onError": "continueErrorOutput",
      "parameters": {
        "url": "=https://api.hunter.io/v2/email-finder?domain={{ $json.domain }}&first_name={{ $json.first_name }}&last_name={{ $json.last_name }}&api_key=cdf1ba76c5d3f5d994ac2152754dacf6b0fad52b",
        "options": {
          "timeout": 30000
        }
      }
    },
    {
      "id": "0933aed9-073f-44e1-b079-7b49b7d000f2",
      "name": "Extract Email Information",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2528,
        0
      ],
      "parameters": {
        "jsCode": "const allData = [];\nconst inputItems = $input.all();\n\nfor (let i = 0; i < inputItems.length; i++) {\n  const item = inputItems[i];\n  let emailData = null;\n  \n  if (item.json && item.json.data) {\n    emailData = item.json.data;\n  }\n  \n  const prevNodes = $('Split CEO Name').all();\n  let prevData = {};\n  \n  if (prevNodes.length > 0 && i < prevNodes.length) {\n    prevData = prevNodes[i].json;\n  }\n  \n  const companyName = prevData.company_name || 'Unknown';\n  const ceoName = prevData.ceo_name || '';\n  \n  let ceoEmail = '';\n  let matchMethod = '';\n  \n  if (emailData && emailData.email) {\n    const email = emailData.email;\n    const position = (emailData.position || '').toLowerCase();\n    const score = emailData.score || 0;\n    \n    let isMatch = false;\n    \n    if (position.includes('ceo') || position.includes('chief executive') ||\n        position.includes('founder') || position.includes('president')) {\n      isMatch = true;\n      matchMethod = `Executive position: ${position}`;\n    }\n    \n    if (!isMatch && score > 80) {\n      const emailLocal = email.split('@')[0].toLowerCase();\n      const genericPrefixes = ['info', 'contact', 'support', 'sales', 'admin'];\n      const isGeneric = genericPrefixes.some(prefix => emailLocal.startsWith(prefix));\n      \n      if (!isGeneric) {\n        isMatch = true;\n        matchMethod = `High confidence score: ${score}`;\n      }\n    }\n    \n    if (isMatch) {\n      ceoEmail = email;\n    }\n  }\n  \n  const result = {\n    ...prevData,\n    ceo_email: ceoEmail || 'Not found',\n    email_match_method: matchMethod || 'No valid email found',\n    hunter_score: emailData?.score || 0\n  };\n  \n  allData.push(result);\n}\n\nreturn allData;"
      }
    },
    {
      "id": "dfcabb36-d378-40ed-a1da-4341176e1617",
      "name": "4. Scrape Recent Company News",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        3088,
        0
      ],
      "onError": "continueErrorOutput",
      "parameters": {
        "method": "POST",
        "url": "https://google.serper.dev/news",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $json.company_name }} recent news"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "odw0FaTRUSGiHCOl",
          "name": "Serper dev Header Auth account"
        }
      }
    },
    {
      "id": "278e89b2-3a38-4681-970f-f653eba3eb5e",
      "name": "Extract News Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3376,
        0
      ],
      "parameters": {
        "jsCode": "const allData = [];\n\nfor (const item of $input.all()) {\n  const newsResults = item.json.news || [];\n  const prevData = $('Extract Email Information').all()[0]?.json || {};\n  \n  let recentNews = [];\n  let newsTopics = [];\n\n  for (const article of newsResults.slice(0, 3)) {\n    const title = article.title || '';\n    const snippet = article.snippet || '';\n    const link = article.link || '';\n    const date = article.date || '';\n    const source = article.source || '';\n    \n    if (title && snippet) {\n      recentNews.push({\n        title: title,\n        snippet: snippet,\n        link: link,\n        date: date,\n        source: source\n      });\n      \n      const titleLower = title.toLowerCase();\n      if (titleLower.includes('funding') || titleLower.includes('investment')) {\n        newsTopics.push('Funding/Investment');\n      }\n      if (titleLower.includes('partnership') || titleLower.includes('collaboration')) {\n        newsTopics.push('Partnership');\n      }\n      if (titleLower.includes('product') || titleLower.includes('launch')) {\n        newsTopics.push('Product Launch');\n      }\n      if (titleLower.includes('expansion') || titleLower.includes('growth')) {\n        newsTopics.push('Expansion');\n      }\n      if (titleLower.includes('acquisition') || titleLower.includes('merger')) {\n        newsTopics.push('M&A');\n      }\n    }\n  }\n\n  let newsSummary = '';\n  if (recentNews.length > 0) {\n    const latestNews = recentNews[0];\n    newsSummary = `Latest: ${latestNews.title} - ${latestNews.snippet.substring(0, 150)}...`;\n  }\n\n  allData.push({\n    ...prevData,\n    recent_news: recentNews,\n    news_summary: newsSummary || 'No recent news found',\n    news_topics: [...new Set(newsTopics)],\n    news_count: recentNews.length\n  });\n}\n\nreturn allData;"
      }
    },
    {
      "id": "7bf96a25-b0fe-4770-b24a-4b64b138f628",
      "name": "5. Generate Personalized Outreach with Gemini",
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        3568,
        0
      ],
      "parameters": {
        "resource": "text",
        "operation": "message",
        "modelId": {
          "__rl": true,
          "mode": "id",
          "value": "gemini-1.5-flash"
        },
        "messages": {
          "values": [
            {
              "role": "user",
              "content": "=Based on the following company information, write a personalized outreach email:\n\nCompany: {{ $json.company_name }}\nCEO: {{ $json.ceo_name }} ({{ $json.ceo_title }})\nEmail: {{ $json.ceo_email }}\nWebsite: {{ $json.website }}\nRecent News: {{ $json.news_summary }}\n\nWrite a brief, professional outreach email that:\n1. Addresses the CEO by name\n2. References their recent news or achievements\n3. Proposes a relevant business opportunity\n4. Keeps it under 150 words\n5. Has a clear call-to-action\n\nFormat as a complete email with subject line."
            }
          ]
        },
        "options": {
          "temperature": 0.7
        }
      },
      "credentials": {
        "googlePalmApi": {
          "id": "AddN13YCTv8VpGh7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "id": "6b2de309-1b13-49cb-ba3c-ccea9b48af0a",
      "name": "Prepare Data for Sheet Update",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        3936,
        0
      ],
      "parameters": {
        "fields": {
          "values": [
            {
              "name": "outreach_email",
              "stringValue": "={{ $json.response }}"
            },
            {
              "name": "company_name",
              "stringValue": "={{ $json.company_name }}"
            },
            {
              "name": "ceo_name",
              "stringValue": "={{ $json.ceo_name }}"
            },
            {
              "name": "ceo_email",
              "stringValue": "={{ $json.ceo_email }}"
            },
            {
              "name": "website",
              "stringValue": "={{ $json.website }}"
            },
            {
              "name": "news_summary",
              "stringValue": "={{ $json.news_summary }}"
            }
          ]
        },
        "include": "selected",
        "options": {}
      }
    },
    {
      "id": "e37b6a3e-3dba-40bf-ac52-7c587d10bc1e",
      "name": "Error Handler",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        1088,
        224
      ],
      "parameters": {
        "fields": {
          "values": [
            {
              "name": "error_message",
              "stringValue": "=Error occurred in workflow"
            },
            {
              "name": "error_node",
              "stringValue": "={{ $json.$node.name }}"
            }
          ]
        },
        "options": {}
      }
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "1. Read Companies from Google Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. Read Companies from Google Sheet": {
      "main": [
        [
          {
            "node": "Split Companies for Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Companies for Processing": {
      "main": [
        [],
        [
          {
            "node": "Extract Company Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Company Data": {
      "main": [
        [
          {
            "node": "2. Scrape Company Information",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2. Scrape Company Information": {
      "main": [
        [
          {
            "node": "Extract Company Details",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Company Details": {
      "main": [
        [
          {
            "node": "3. Find CEO LinkedIn Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. Find CEO LinkedIn Profile": {
      "main": [
        [
          {
            "node": "Extract CEO Information",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract CEO Information": {
      "main": [
        [
          {
            "node": "Split CEO Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split CEO Name": {
      "main": [
        [
          {
            "node": "Find CEO Email Address",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find CEO Email Address": {
      "main": [
        [
          {
            "node": "Extract Email Information",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Email Information": {
      "main": [
        [
          {
            "node": "4. Scrape Recent Company News",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. Scrape Recent Company News": {
      "main": [
        [
          {
            "node": "Extract News Content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract News Content": {
      "main": [
        [
          {
            "node": "5. Generate Personalized Outreach with Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5. Generate Personalized Outreach with Gemini": {
      "main": [
        [
          {
            "node": "Prepare Data for Sheet Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Handler": {
      "main": [
        [
          {
            "node": "Split Companies for Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "saveExecutionProgress": true
  },
  "staticData": null,
  "meta": null,
  "pinData": null,
  "versionId": "3502a1f4-7f7b-4ef5-b923-41cc51f9d20a",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-09-25T08:03:13.898Z",
      "updatedAt": "2025-09-25T08:03:13.898Z",
      "role": "workflow:owner",
      "workflowId": "Doq6cC4zb2Icymxn",
      "projectId": "nnULjHyqOVknXpmc"
    }
  ],
  "tags": []
}