{
  "createdAt": "2025-10-10T11:11:27.272Z",
  "updatedAt": "2025-10-11T07:22:10.000Z",
  "id": "SBiI0U83JII8W5ew",
  "name": "kiwi gift hamper workflow",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Conversation state manager\nconst body = $input.item.json.body || $input.item.json;\nconst userMessage = body.message || '';\nconst currentStep = body.step || 0;\nconst sessionData = body.sessionData || {};\n\nconst questions = [\n  { id: 0, field: 'budget', question: 'What is your Budget per piece? (e.g., 1000/-)', type: 'number' },\n  { id: 1, field: 'quantity', question: 'What is your quantity? (e.g., 100pcs)', type: 'number' },\n  { id: 2, field: 'deadline', question: 'When do you need it? (e.g., 10th Oct)', type: 'text' },\n  { id: 3, field: 'hasReference', question: 'Do you have any reference image? (yes/no)', type: 'boolean' },\n  { id: 4, field: 'itemPreference', question: 'What items would you like? (e.g., 4 dry fruits, diya, candle, chips)', type: 'text' },\n  { id: 5, field: 'packagingPreference', question: 'Any packaging preference? (e.g., box type, eco-friendly)', type: 'text' }\n];\n\nconst currentQuestion = questions[currentStep];\n\nif (currentStep > 0 && userMessage) {\n  const prevQuestion = questions[currentStep - 1];\n  sessionData[prevQuestion.field] = userMessage;\n}\n\n// Bulk discount detection\nlet specialMessage = null;\nif (currentStep === 1 && userMessage) {\n  const qty = parseInt(userMessage.replace(/[^0-9]/g, ''));\n  if (qty >= 200) {\n    specialMessage = 'ðŸŽ‰ Great news! We have a special offer for 200+ pieces with 10% discount (40% off MRP)!';\n  } else if (qty < 200) {\n    specialMessage = 'ðŸ’¡ Orders above 200 pieces get 40% discount. Below 200 pieces get 35% discount.';\n  }\n}\n\nreturn {\n  json: {\n    currentStep: currentStep,\n    nextStep: currentStep + 1,\n    userMessage: userMessage,\n    sessionData: sessionData,\n    currentQuestion: currentQuestion,\n    specialMessage: specialMessage,\n    isComplete: currentStep >= questions.length,\n    sessionId: body.sessionId || $execution.id,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "7fff08fb-31c8-4997-9991-69ca85c0874f",
      "name": "Conversation Manager",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        432
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "step-check",
              "leftValue": "={{ $json.currentStep }}",
              "rightValue": 4,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "13dfb4c6-2d71-4502-9d7b-f6ab7cda7455",
      "name": "Check Item Step",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        80,
        432
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse AI recommendations and extract structured data\nconst aiResponse = $('RAG: Smart Product + Packaging Selection').first().json;\nconst sessionData = $('Conversation Manager').item.json.sessionData;\n\nconst responseText = aiResponse.text || aiResponse.response || '';\n\n// Extract recommended box\nconst boxMatch = responseText.match(/Box:\\s*([^\\n]+)/i);\nconst sizeMatch = responseText.match(/Size:\\s*([0-9.]+)\\s*[xÃ—]\\s*([0-9.]+)\\s*[xÃ—]\\s*([0-9.]+)/i);\nconst packagingCostMatch = responseText.match(/Packaging:\\s*Rs\\s*([0-9,]+)/i);\n\nconst recommendedBox = {\n  name: boxMatch ? boxMatch[1].trim() : 'Medium Box',\n  length: sizeMatch ? parseFloat(sizeMatch[1]) : 30,\n  width: sizeMatch ? parseFloat(sizeMatch[2]) : 20,\n  height: sizeMatch ? parseFloat(sizeMatch[3]) : 15,\n  cost: packagingCostMatch ? parseInt(packagingCostMatch[1].replace(/,/g, '')) : 300\n};\n\nrecommendedBox.dimensions = `${recommendedBox.length}x${recommendedBox.width}x${recommendedBox.height}`;\n\nreturn {\n  json: {\n    aiFullResponse: responseText,\n    recommendedBox: recommendedBox,\n    sessionData: sessionData,\n    retrievedProducts: aiResponse.sourceDocuments?.length || 0\n  }\n};"
      },
      "id": "9682e188-d4d1-4003-9e31-e3e06ea80fba",
      "name": "Parse AI Recommendations",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        640
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "complete",
              "leftValue": "={{ $('Conversation Manager').item.json.isComplete }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "625ac75c-3565-446c-9c0d-592688955e73",
      "name": "Check Complete",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        448,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// Generate final quotation\nconst sessionData = $('Conversation Manager').item.json.sessionData;\nconst aiData = $('Parse AI Recommendations').item.json;\n\nconst budget = parseInt(sessionData.budget) || 1000;\nconst quantity = parseInt(sessionData.quantity.replace(/[^0-9]/g, '')) || 100;\n\n// Calculate discounts\nconst discountPercent = quantity >= 200 ? 40 : 35;\nconst bulkOrderDiscount = quantity >= 200 ? 10 : 0; // Additional bulk discount on total\n\nconst packagingCost = aiData.recommendedBox.cost;\nconst itemsCost = budget - packagingCost;\n\nconst subtotal = budget * quantity;\nconst additionalDiscount = (subtotal * bulkOrderDiscount) / 100;\nconst finalTotal = subtotal - additionalDiscount;\n\nconst quotation = {\n  quotationId: `QT-${Date.now()}`,\n  timestamp: new Date().toISOString(),\n  customerDetails: {\n    budget: budget,\n    quantity: quantity,\n    deadline: sessionData.deadline,\n    itemPreferences: sessionData.itemPreference,\n    packagingPreference: sessionData.packagingPreference\n  },\n  packagingDetails: {\n    boxName: aiData.recommendedBox.name,\n    boxSize: aiData.recommendedBox.dimensions,\n    boxLength: aiData.recommendedBox.length,\n    boxWidth: aiData.recommendedBox.width,\n    boxHeight: aiData.recommendedBox.height,\n    packagingCost: packagingCost,\n    calculation: aiData.aiFullResponse\n  },\n  pricing: {\n    budgetPerPiece: budget,\n    itemsCostPerPiece: itemsCost,\n    packagingCostPerPiece: packagingCost,\n    quantity: quantity,\n    subtotal: subtotal,\n    mrpDiscountPercent: discountPercent,\n    additionalBulkDiscount: bulkOrderDiscount,\n    additionalDiscountAmount: additionalDiscount,\n    finalTotal: finalTotal,\n    savingsFromMRP: `You save ${discountPercent}% on MRP prices!`\n  },\n  aiRecommendation: aiData.aiFullResponse,\n  specialOffer: bulkOrderDiscount > 0 ? `ðŸŽ‰ ${bulkOrderDiscount}% additional bulk discount + ${discountPercent}% MRP discount!` : `âœ¨ ${discountPercent}% discount on MRP applied!`\n};\n\nreturn { json: quotation };"
      },
      "id": "6e800072-5638-4d2f-b234-94786b7ecf34",
      "name": "Generate Final Quotation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        160
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "prompt": "=Create a professional product photograph of a premium gift hamper containing items beautifully arranged. Corporate gifting quality, studio lighting, festive presentation, elegant styling.",
        "options": {},
        "requestOptions": {}
      },
      "id": "8ff616f5-fba4-4a1d-b0bd-2464724e3781",
      "name": "Generate Product Image",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1.1,
      "position": [
        1024,
        160
      ],
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1yY6XaFP1YhHKEOthMCTUen-UHIM3BS064jG-ucl8Igc",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Orders",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData"
        },
        "options": {
          "cellFormat": "USER_ENTERED"
        }
      },
      "id": "f6cea418-45da-40a7-b188-195b6ef85954",
      "name": "Save Order",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        1248,
        160
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "ZG1MR4HwHasbUvb4",
          "name": "Cognigenai Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format final response\nconst quotation = $input.first().json;\nconst imageUrl = $('Generate Product Image').first()?.json?.data?.[0]?.url || null;\n\nreturn {\n  json: {\n    success: true,\n    conversationComplete: true,\n    message: 'âœ¨ Your custom gift hamper quotation is ready with smart packaging!',\n    quotation: quotation,\n    productVisualization: imageUrl,\n    packagingInsights: {\n      selectedBox: quotation.packagingDetails.boxName,\n      boxSize: quotation.packagingDetails.boxSize,\n      whyThisBox: 'AI calculated based on item dimensions + cushioning space'\n    },\n    savingsHighlight: quotation.pricing.savingsFromMRP,\n    nextSteps: [\n      '1. Review quotation and packaging details',\n      '2. Confirm your order',\n      '3. Proceed with payment',\n      '4. Production and delivery by ' + quotation.customerDetails.deadline\n    ]\n  }\n};"
      },
      "id": "2b04ed62-3ecf-4b30-ad4d-ab0237a32602",
      "name": "Format Final Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1472,
        160
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format ongoing conversation response\nconst convData = $('Conversation Manager').item.json;\nconst aiData = $('Parse AI Recommendations').first()?.json;\n\nlet response = {\n  success: true,\n  conversationComplete: false,\n  currentStep: convData.currentStep,\n  nextStep: convData.nextStep,\n  sessionId: convData.sessionId\n};\n\nif (aiData && aiData.aiFullResponse) {\n  response.message = aiData.aiFullResponse + '\\n\\n' + (convData.currentQuestion?.question || 'What would you like to do next?');\n  response.aiRecommendations = aiData.aiFullResponse;\n  response.packagingSuggestion = aiData.recommendedBox;\n} else if (convData.specialMessage) {\n  response.message = convData.specialMessage + '\\n\\n' + convData.currentQuestion.question;\n} else if (convData.currentQuestion) {\n  response.message = convData.currentQuestion.question;\n} else {\n  response.message = 'Processing your request...';\n}\n\nif (convData.currentStep === 3) {\n  response.imageUploadEnabled = true;\n}\n\nreturn { json: response };"
      },
      "id": "029ec134-b6c3-46e3-a4af-198c324f7128",
      "name": "Format Conversation Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1024,
        560
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "options": {}
      },
      "id": "872e66e2-f50f-4223-8b8e-3474abc4786f",
      "name": "Merge Final Response",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1696,
        432
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json, null, 2) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "ec7c44b9-8d53-47c3-a717-bc9cd8d44812",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1920,
        432
      ]
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        -112,
        1296
      ],
      "id": "e98f679a-97dc-40b2-96bb-3346bbdc06b7",
      "name": "Embeddings Google Gemini",
      "credentials": {
        "googlePalmApi": {
          "id": "13GUWdzP5u5goYYi",
          "name": "Google Gemini(PaLM) Api account - Ansh"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ 'Find products for a gift hamper with these items: ' + $json.sessionData.itemPreference + '. Budget is Rs ' + $json.sessionData.budget + ' per piece for ' + $json.sessionData.quantity + ' pieces. Recommend suitable products and packaging.' }}",
        "options": {}
      },
      "id": "96f9dd8c-831e-44d8-8df2-7b7729b28ed8",
      "name": "RAG: Smart Product + Packaging Selection",
      "type": "@n8n/n8n-nodes-langchain.chainRetrievalQa",
      "typeVersion": 1.3,
      "position": [
        480,
        640
      ]
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.retrieverVectorStore",
      "typeVersion": 1,
      "position": [
        224,
        864
      ],
      "id": "e74714fa-85e3-4ae5-b5b8-55720465fb1d",
      "name": "Vector Store Retriever"
    },
    {
      "parameters": {
        "pineconeIndex": {
          "__rl": true,
          "value": "cgragtest",
          "mode": "list",
          "cachedResultName": "cgragtest"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1.3,
      "position": [
        32,
        1056
      ],
      "id": "bf742cd0-936d-44ea-8473-984a72087b26",
      "name": "Pinecone Vector Store",
      "credentials": {
        "pineconeApi": {
          "id": "aWTuoJ6ldBZ2gPsm",
          "name": "PineconeApi account - cognigenai"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        592,
        880
      ],
      "id": "e51f0b0a-d3c2-4529-a809-367c3690fae9",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "13GUWdzP5u5goYYi",
          "name": "Google Gemini(PaLM) Api account - Ansh"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "session",
              "name": "sessionData",
              "value": "={{ $('Conversation Manager').item.json.sessionData }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "eefe0910-a2ed-406e-874a-63c2241a2a5d",
      "name": "Pass Session Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        288,
        640
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "hamper-chatbot",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger-new",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -368,
        432
      ],
      "webhookId": "96af4488-f69e-4be0-89c8-2905e32ba98c"
    }
  ],
  "connections": {
    "Conversation Manager": {
      "main": [
        [
          {
            "node": "Check Item Step",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Item Step": {
      "main": [
        [
          {
            "node": "Check Complete",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pass Session Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Recommendations": {
      "main": [
        [
          {
            "node": "Format Conversation Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Complete": {
      "main": [
        [
          {
            "node": "Generate Final Quotation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Conversation Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Final Quotation": {
      "main": [
        [
          {
            "node": "Generate Product Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Product Image": {
      "main": [
        [
          {
            "node": "Save Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Order": {
      "main": [
        [
          {
            "node": "Format Final Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Final Response": {
      "main": [
        [
          {
            "node": "Merge Final Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Conversation Response": {
      "main": [
        [
          {
            "node": "Merge Final Response",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Final Response": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Google Gemini": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "RAG: Smart Product + Packaging Selection": {
      "main": [
        [
          {
            "node": "Parse AI Recommendations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vector Store Retriever": {
      "ai_retriever": [
        [
          {
            "node": "RAG: Smart Product + Packaging Selection",
            "type": "ai_retriever",
            "index": 0
          }
        ]
      ]
    },
    "Pinecone Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "Vector Store Retriever",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "RAG: Smart Product + Packaging Selection",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Pass Session Data": {
      "main": [
        [
          {
            "node": "RAG: Smart Product + Packaging Selection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Conversation Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "dc15b24b-728f-4f32-8722-325cc64d52f3",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-10-10T11:11:27.275Z",
      "updatedAt": "2025-10-10T11:11:27.275Z",
      "role": "workflow:owner",
      "workflowId": "SBiI0U83JII8W5ew",
      "projectId": "nnULjHyqOVknXpmc"
    }
  ],
  "tags": []
}