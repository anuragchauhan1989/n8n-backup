{
  "createdAt": "2025-10-24T09:44:56.464Z",
  "updatedAt": "2025-10-30T04:59:33.000Z",
  "id": "zgX8K1dD20x9AGc7",
  "name": "fitwithpari",
  "active": false,
  "isArchived": true,
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -32,
        -384
      ],
      "id": "2a6ea94a-9253-4e93-900c-05d5c96875d5",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai-agents/create-profiles",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1296,
        -336
      ],
      "id": "23bc31d9-cb2d-41c4-8195-b98172d36f6b",
      "name": "Webhook",
      "webhookId": "8e7037cf-81cf-463d-b4b6-ce374db5fd03"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "89423bc8-2b83-4a38-bf80-95ee2bb34b60",
              "leftValue": "={{ $json.body.data.form_type }}",
              "rightValue": "assessment",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -688,
        -192
      ],
      "id": "ad94e87d-ef5a-40bc-b653-a1a1e07335d7",
      "name": "If assessment"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "64e55d8b-73b5-4ad3-a7a3-dfd7fa9ff7ba",
              "leftValue": "={{ $json.body.data.form_type }}",
              "rightValue": "feedback",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -688,
        -32
      ],
      "id": "3d7ee403-7e89-4e7c-a74d-09317e1379fb",
      "name": "If feedback"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e5a36f37-27b3-4c15-94e0-b136cfb135c3",
              "name": "body",
              "value": "={{ $json.body }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -896,
        -352
      ],
      "id": "1827092b-a1d9-4a6a-b1ec-1ec42802b5ff",
      "name": "Set Body Only"
    },
    {
      "parameters": {
        "jsCode": "// Get the input data\nconst input = $input.first().json;\n\nconsole.log('=== Transform Onboarding - Input ===');\nconsole.log(JSON.stringify(input, null, 2));\n\n// Extract data based on structure\nlet transformedData;\nlet sessionId;\n\nif (input.body?.data) {\n  transformedData = input.body.data;\n  sessionId = input.body.session_id || null;\n} else if (input.data) {\n  transformedData = input.data;\n  sessionId = input.session_id || null;\n} else {\n  transformedData = input;\n  sessionId = null;\n}\n\nconsole.log('=== Transform Onboarding - Output ===');\nconsole.log('Session ID:', sessionId);\nconsole.log(JSON.stringify(transformedData, null, 2));\n\n// Return with session ID for memory\nreturn {\n  json: {\n    sessionId: sessionId,\n    ...transformedData\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        -368
      ],
      "id": "d0a4f1a6-c26a-40ce-8951-3b156d37a976",
      "name": "Transform Onboarding Form"
    },
    {
      "parameters": {
        "jsCode": "// Get the input data\nconst input = $input.first().json;\n\nconsole.log('=== Transform Assessment - Input ===');\nconsole.log(JSON.stringify(input, null, 2));\n\n// Extract data based on structure\nlet transformedData;\nlet sessionId;\n\nif (input.body?.data) {\n  transformedData = input.body.data;\n  sessionId = input.body.session_id || null;\n} else if (input.data) {\n  transformedData = input.data;\n  sessionId = input.session_id || null;\n} else {\n  transformedData = input;\n  sessionId = null;\n}\n\nconsole.log('=== Transform Assessment - Output ===');\nconsole.log('Session ID:', sessionId);\nconsole.log(JSON.stringify(transformedData, null, 2));\n\n// Return with session ID for memory\nreturn {\n  json: {\n    sessionId: sessionId,\n    ...transformedData\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        -208
      ],
      "id": "04f50fce-6bd6-485a-bf44-7ded6f666f35",
      "name": "Transform Assesment Form"
    },
    {
      "parameters": {
        "jsCode": "// Get the input data\nconst input = $input.first().json;\n\nconsole.log('=== Transform Feedback - Input ===');\nconsole.log(JSON.stringify(input, null, 2));\n\n// Extract data based on structure\nlet transformedData;\nlet sessionId;\n\nif (input.body?.data) {\n  transformedData = input.body.data;\n  sessionId = input.body.session_id || null;\n} else if (input.data) {\n  transformedData = input.data;\n  sessionId = input.session_id || null;\n} else {\n  transformedData = input;\n  sessionId = null;\n}\n\nconsole.log('=== Transform Feedback - Output ===');\nconsole.log('Session ID:', sessionId);\nconsole.log(JSON.stringify(transformedData, null, 2));\n\n// Return with session ID for memory\nreturn {\n  json: {\n    sessionId: sessionId,\n    ...transformedData\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        -48
      ],
      "id": "99b9eaee-9842-4e22-a22f-33f33710d993",
      "name": "Transform Feedback Form"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"error\": \"make sure to send form type\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -400,
        160
      ],
      "id": "c2ba6547-ca31-4646-9033-5795a6970e0a",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.data.session_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        144,
        -384
      ],
      "id": "769825f5-112d-482b-86b5-70d608792540",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0f7201b6-2908-4661-8eed-50e4fdb78119",
              "leftValue": "={{ $json.body }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1104,
        -336
      ],
      "id": "6d97d46b-6ae0-4814-86b8-963c659b86c0",
      "name": "If"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate a comprehensive long-term student profile that serves as a complete record of the student's fitness journey and key health indicators.\n\n**INPUT DATA (for analysis and extraction):**\n{{ JSON.stringify($json.data, null, 2) }}\n\n**Task Steps:**\n1. **Retrieve:** Use the RAG tool to find the required JSON structure and content rules.\n2. **Analyze:** Extract data from the INPUT DATA according to the rules (bilateral analysis, safety, goals, etc.) retrieved from the RAG.\n3. **Generate:** Produce the final PURE JSON object containing the `student_id`, `source_assessment_id`, the complete `profile_json`, and a comprehensive `summary_text` (150-250 words), matching the retrieved RAG output format.",
        "options": {
          "systemMessage": "=You are an expert fitness assessment analyst creating comprehensive long-term student profiles.\n\nðŸš¨ **MANDATORY WORKFLOW - USE RAG TOOL FIRST:**\nYou **MUST** use the RAG tool (profile_creation_knowledge_base) to retrieve the required **JSON structure**, **data extraction priorities**, and **clinical rules** before attempting to generate the output. Your primary task is to retrieve these rules and then apply them to the student's input data.\n\n**OUTPUT REQUIREMENTS:**\n1. Your entire response **MUST** be a single, valid JSON object that adheres **STRICTLY** to the structure and rules retrieved from the RAG tool search.\n2. Return **ONLY** pure JSONâ€”no markdown, code blocks, or explanatory text.\n3. Must have exactly FOUR top-level keys: student_id, source_assessment_id, profile_json, summary_text.\n4. Apply all formatting standards and bilateral analysis rules found in the retrieved RAG content.\n\n**CRITICAL: Your first action must be a call to the RAG tool to retrieve the complete formatting and content guidelines.**\n\nYour first character must be { and your last character must be }."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -16,
        -208
      ],
      "id": "3ae19cde-d5e3-4cd4-8a2a-01034054e34f",
      "name": "Long Profile Agent",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "tableId": "student_profiles_full",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "student_id",
              "fieldValue": "={{ $json.student_id }}"
            },
            {
              "fieldId": "profile_json",
              "fieldValue": "={{ $json.profile_json }}"
            },
            {
              "fieldId": "summary_text",
              "fieldValue": "={{ $json.summary_text }}"
            },
            {
              "fieldId": "source_assessment_id",
              "fieldValue": "={{ $json.source_assessment_id }}"
            },
            {
              "fieldId": "generator_meta",
              "fieldValue": "={{ $json.generator_meta }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        576,
        -208
      ],
      "id": "e4e152ce-220a-4d26-b257-24f2ad6614b5",
      "name": "Add Long Profile",
      "credentials": {
        "supabaseApi": {
          "id": "Q73MSqamXZ7oNsc2",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// This script cleans the assessment data and wraps it in a single 'data' field \n// for efficient token consumption by the AI Agent.\n\nconst inputItem = $input.first().json;\n\n// --- Helper function to safely extract the response value ---\nfunction getResponseValue(response) {\n    if (response === null) return null;\n    \n    // Handle specific boolean response\n    if (typeof response.response === 'boolean') {\n        return response.response;\n    }\n    // Handle array response (multiselect)\n    if (Array.isArray(response.response)) {\n        return response.response;\n    }\n    // Return number/string response, or null if key is missing\n    if (response.response !== undefined) {\n        return response.response;\n    }\n    return null;\n}\n\n// --- 1. Distill Questions and Answers ---\nconst cleanedTests = inputItem.test_results.map(test => {\n    // Distill questions and answers\n    const cleanedQuestions = test.questions.map(question => ({\n        question_text: question.question_text,\n        question_type: question.question_type,\n        response: getResponseValue(question.response),\n        unit: question.validation_rules?.unit || null \n    }));\n\n    return {\n        test_name: test.test_name,\n        test_category: test.test_category,\n        completed_at: test.completed_at,\n        questions_and_answers: cleanedQuestions\n    };\n});\n\n// --- 2. Build the Final Optimized Payload ---\nconst optimizedPayload = {\n    // === FIX: Retrieve session_id and form_type directly from the input item ===\n    session_id: inputItem.sessionId || null, \n    form_type: inputItem.form_type || null, \n    // =========================================================================\n\n    // Essential Student/Coach Context\n    student_id: inputItem.assessment.student_id,\n    assessment_id: inputItem.assessment.id,\n    \n    student_profile: {\n        full_name: inputItem.assessment.student.full_name,\n        date_of_birth: inputItem.assessment.student.date_of_birth,\n        fitness_goal: inputItem.assessment.student.fitness_goal,\n    },\n    \n    coach_info: {\n        full_name: inputItem.assessment.coach.full_name,\n        specialties: inputItem.assessment.coach.specialties\n    },\n    \n    // Distilled Test Results\n    tests: cleanedTests,\n    \n    // Key Summary Findings (most valuable for LLM analysis)\n    summary_findings: {\n        bilateral_comparisons: inputItem.summary.bilateral_comparisons,\n        key_findings: inputItem.summary.key_findings,\n        recommendations: inputItem.summary.recommendations\n    }\n};\n\n// --- 3. Wrap in the required 'data' field and return ---\nreturn [{ \n    json: {\n        data: optimizedPayload \n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -192,
        -208
      ],
      "id": "11a6b7c0-c0ed-491c-9686-daa938d43486",
      "name": "Extract Required Fields"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// PARSE LONG PROFILE - ENHANCED VERSION WITH AGGRESSIVE CLEANING\n// ============================================================================\n\nconst input = $input.first().json;\nconsole.log('=== Parse Long Profile - START ===');\n\n// --- HELPER FUNCTION: Extract JSON from any format ---\nfunction extractJSON(data) {\n  let jsonString;\n  \n  // If already an object, stringify it\n  if (typeof data === 'object' && data !== null) {\n    return data;\n  }\n  \n  // If string, clean it aggressively\n  if (typeof data === 'string') {\n    jsonString = data;\n    \n    // Remove all markdown code block markers\n    jsonString = jsonString.replace(/```(?:json|javascript|js)?\\s*/gi, '');\n    jsonString = jsonString.replace(/```\\s*/g, '');\n    \n    // Remove leading \"json\" or \"JSON\" text\n    jsonString = jsonString.replace(/^json\\s*/i, '');\n    \n    // Trim whitespace\n    jsonString = jsonString.trim();\n    \n    // Find the first { and last } using brace matching\n    const firstBrace = jsonString.indexOf('{');\n    if (firstBrace === -1) {\n      throw new Error('No opening brace found in agent output');\n    }\n    \n    // Match braces to find the complete JSON object\n    let braceCount = 0;\n    let lastBrace = -1;\n    \n    for (let i = firstBrace; i < jsonString.length; i++) {\n      if (jsonString[i] === '{') braceCount++;\n      if (jsonString[i] === '}') {\n        braceCount--;\n        if (braceCount === 0) {\n          lastBrace = i;\n          break;\n        }\n      }\n    }\n    \n    if (lastBrace === -1) {\n      throw new Error('No matching closing brace found');\n    }\n    \n    jsonString = jsonString.substring(firstBrace, lastBrace + 1);\n    \n    // Parse the cleaned JSON\n    try {\n      return JSON.parse(jsonString);\n    } catch (e) {\n      console.error('JSON Parse Error:', e.message);\n      console.error('Cleaned JSON (first 500 chars):', jsonString.substring(0, 500));\n      throw new Error(`Failed to parse JSON: ${e.message}`);\n    }\n  }\n  \n  throw new Error(`Unexpected data type: ${typeof data}`);\n}\n\n// --- HELPER FUNCTION: Clean text content ---\nfunction cleanText(text) {\n  if (!text || typeof text !== 'string') return text;\n  \n  return text\n    // Remove escaped quotes\n    .replace(/\\\\\"/g, '\"')\n    .replace(/\\\\'/g, \"'\")\n    // Remove extra backslashes\n    .replace(/\\\\\\\\/g, '\\\\')\n    // Remove markdown bold/italic\n    .replace(/\\*\\*(.+?)\\*\\*/g, '$1')\n    .replace(/\\*(.+?)\\*/g, '$1')\n    .replace(/__(.+?)__/g, '$1')\n    .replace(/_(.+?)_/g, '$1')\n    // Clean up extra spaces\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\n// --- HELPER FUNCTION: Recursively clean an object ---\nfunction deepCleanObject(obj) {\n  if (obj === null || obj === undefined) return obj;\n  \n  if (typeof obj === 'string') {\n    return cleanText(obj);\n  }\n  \n  if (Array.isArray(obj)) {\n    return obj.map(item => deepCleanObject(item));\n  }\n  \n  if (typeof obj === 'object') {\n    const cleaned = {};\n    for (const [key, value] of Object.entries(obj)) {\n      cleaned[key] = deepCleanObject(value);\n    }\n    return cleaned;\n  }\n  \n  return obj;\n}\n\n// --- 1. EXTRACT AND PARSE ---\nlet rawOutput = input.output || input.json || input.text || input;\nconsole.log('Raw output type:', typeof rawOutput);\n\nlet parsedData;\ntry {\n  parsedData = extractJSON(rawOutput);\n  console.log('âœ“ Successfully extracted JSON');\n} catch (error) {\n  console.error('âœ— Failed to extract JSON:', error.message);\n  throw error;\n}\n\n// --- 2. VALIDATE REQUIRED FIELDS ---\nconst requiredFields = ['student_id', 'source_assessment_id', 'profile_json', 'summary_text'];\nconst missingFields = requiredFields.filter(field => !parsedData[field]);\n\nif (missingFields.length > 0) {\n  throw new Error(`Missing required fields: ${missingFields.join(', ')}`);\n}\n\nif (typeof parsedData.profile_json !== 'object') {\n  throw new Error('profile_json must be an object');\n}\n\nconsole.log('âœ“ All required fields present');\n\n// --- 3. DEEP CLEAN ALL TEXT CONTENT ---\nconst cleanedProfileJson = deepCleanObject(parsedData.profile_json);\nconst cleanedSummary = cleanText(parsedData.summary_text);\n\nconsole.log('âœ“ Text content cleaned');\n\n// --- 4. BUILD FINAL RECORD ---\nconst generatorMeta = {\n  llm_version: cleanedProfileJson.llm_version || 'gpt-4o-long_v1',\n  generated_at: cleanedProfileJson.generated_at || new Date().toISOString(),\n  workflow_id: $workflow.id || null,\n  execution_id: $execution.id || null,\n  processing_timestamp: new Date().toISOString()\n};\n\nconst supabaseRecord = {\n  student_id: parsedData.student_id,\n  profile_json: cleanedProfileJson,\n  summary_text: cleanedSummary,\n  source_assessment_id: parsedData.source_assessment_id || null,\n  generator_meta: generatorMeta\n};\n\nconsole.log('=== Parse Long Profile - SUMMARY ===');\nconsole.log('Student ID:', supabaseRecord.student_id);\nconsole.log('Summary preview:', cleanedSummary.substring(0, 100));\nconsole.log('âœ“ Parse complete');\n\nreturn { json: supabaseRecord };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        -208
      ],
      "id": "b7641443-b3d8-4386-a47f-3d543e4ac4b9",
      "name": "Parse Long Profile"
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Search the FitwithPari **Profile Creation Knowledge Base** to find guidelines, structure examples, and rules for generating a **Comprehensive Long Student Profile**.\n\nThe knowledge base contains:\n- The required **JSON structure** for the final output.\n- **Section-specific rules** for data extraction (e.g., how to calculate bilateral deficits, priority levels).\n- **Clinical data extraction requirements** (e.g., safety, movement observations).\n- **Full example profiles** for reference.\n\nUse this tool **extensively** to ensure the generated JSON output adheres strictly to the detailed long profile format and content requirements.\n\nExample queries:\n- \"long profile required JSON output structure\"\n- \"rules for calculating bilateral deficits and priority\"\n- \"example long profile persona and medical integration\"\n- \"data extraction requirements for medical concerns and restrictions\"",
        "tableName": {
          "__rl": true,
          "value": "student_profiles_long_embeddings",
          "mode": "list",
          "cachedResultName": "student_profiles_long_embeddings"
        },
        "topK": 1000,
        "options": {
          "queryName": "retrieve_long_docs"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        48,
        0
      ],
      "id": "2173bfab-90cf-4e18-ac05-4471aca0ca43",
      "name": "Supabase Vector Store2",
      "credentials": {
        "supabaseApi": {
          "id": "Q73MSqamXZ7oNsc2",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        48,
        144
      ],
      "id": "57ebd3dd-93e0-4dec-b409-3fff4702d354",
      "name": "Embeddings OpenAI2",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "=Search the fitness profile knowledge base for examples of student profiles, coaching guidelines, and best practices. This tool MUST be used before generating any profiles to ensure consistency with existing database patterns. Query with terms like \"student profile structure\", \"yoga profile example\", \"strength training guidelines\", or specific workout format names.\n\nTable Name: student_profiles_short_embeddings âœ“\n\nTop K: 10 (increase from 5 for better results)\n\nSimilarity Threshold: 0.5 (add this to filter low-quality matches)",
        "tableName": {
          "__rl": true,
          "value": "student_profiles_short_embeddings",
          "mode": "list",
          "cachedResultName": "student_profiles_short_embeddings"
        },
        "topK": 100,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        528,
        48
      ],
      "id": "160148ac-4731-4750-8e38-9e493ed18236",
      "name": "search_knowledge_base",
      "credentials": {
        "supabaseApi": {
          "id": "VKoabbJQnegsVFoB",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        448,
        592
      ],
      "id": "920424b6-44aa-4e46-8d25-8e3f206bf32e",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// PARSE SHORT PROFILE - UPDATED TO HANDLE ARRAY OUTPUT\n// ============================================================================\n\nconst input = $input.first().json;\nconsole.log('=== Parse Short Profile - START ===');\nconsole.log('Input type:', typeof input);\nconsole.log('Input keys:', Object.keys(input));\n\n// --- HELPER FUNCTION: Extract JSON from any format ---\nfunction extractJSON(data) {\n  let jsonString;\n  \n  // If already an object or array, return it\n  if (typeof data === 'object' && data !== null) {\n    return data;\n  }\n  \n  // If string, clean it aggressively\n  if (typeof data === 'string') {\n    jsonString = data;\n    \n    // Remove all markdown code block markers\n    jsonString = jsonString.replace(/```(?:json|javascript|js)?\\s*/gi, '');\n    jsonString = jsonString.replace(/```\\s*/g, '');\n    \n    // Remove leading \"json\" or \"JSON\" text\n    jsonString = jsonString.replace(/^json\\s*/i, '');\n    \n    // Trim whitespace\n    jsonString = jsonString.trim();\n    \n    // Find the first opening bracket (array or object)\n    const firstBracket = Math.min(\n      jsonString.indexOf('{') !== -1 ? jsonString.indexOf('{') : Infinity,\n      jsonString.indexOf('[') !== -1 ? jsonString.indexOf('[') : Infinity\n    );\n    \n    if (firstBracket === Infinity) {\n      throw new Error('No opening bracket found in agent output');\n    }\n    \n    // Determine if it's an array or object\n    const isArray = jsonString[firstBracket] === '[';\n    const openChar = isArray ? '[' : '{';\n    const closeChar = isArray ? ']' : '}';\n    \n    // Match brackets to find the complete JSON\n    let bracketCount = 0;\n    let lastBracket = -1;\n    \n    for (let i = firstBracket; i < jsonString.length; i++) {\n      if (jsonString[i] === openChar) bracketCount++;\n      if (jsonString[i] === closeChar) {\n        bracketCount--;\n        if (bracketCount === 0) {\n          lastBracket = i;\n          break;\n        }\n      }\n    }\n    \n    if (lastBracket === -1) {\n      throw new Error('No matching closing bracket found');\n    }\n    \n    jsonString = jsonString.substring(firstBracket, lastBracket + 1);\n    \n    // Parse the cleaned JSON\n    try {\n      return JSON.parse(jsonString);\n    } catch (e) {\n      console.error('JSON Parse Error:', e.message);\n      console.error('Cleaned JSON (first 500 chars):', jsonString.substring(0, 500));\n      throw new Error(`Failed to parse JSON: ${e.message}`);\n    }\n  }\n  \n  throw new Error(`Unexpected data type: ${typeof data}`);\n}\n\n// --- HELPER FUNCTION: Clean text content ---\nfunction cleanText(text) {\n  if (!text || typeof text !== 'string') return text;\n  \n  return text\n    // Remove escaped quotes\n    .replace(/\\\\\"/g, '\"')\n    .replace(/\\\\'/g, \"'\")\n    // Remove extra backslashes\n    .replace(/\\\\\\\\/g, '\\\\')\n    // Remove markdown bold/italic\n    .replace(/\\*\\*(.+?)\\*\\*/g, '$1')\n    .replace(/\\*(.+?)\\*/g, '$1')\n    .replace(/__(.+?)__/g, '$1')\n    .replace(/_(.+?)_/g, '$1')\n    // Clean up extra spaces\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\n// --- HELPER FUNCTION: Recursively clean an object ---\nfunction deepCleanObject(obj) {\n  if (obj === null || obj === undefined) return obj;\n  \n  if (typeof obj === 'string') {\n    return cleanText(obj);\n  }\n  \n  if (Array.isArray(obj)) {\n    return obj.map(item => deepCleanObject(item));\n  }\n  \n  if (typeof obj === 'object') {\n    const cleaned = {};\n    for (const [key, value] of Object.entries(obj)) {\n      cleaned[key] = deepCleanObject(value);\n    }\n    return cleaned;\n  }\n  \n  return obj;\n}\n\n// --- 1. EXTRACT RAW OUTPUT ---\nlet rawOutput = input.output || input.json || input.text || input;\nconsole.log('Raw output type:', typeof rawOutput);\n\n// --- 2. HANDLE ARRAY WRAPPER ---\n// The Student Short Profile agent returns an array with one item containing an \"output\" property\nif (Array.isArray(rawOutput) && rawOutput.length > 0) {\n  console.log('âœ“ Detected array output');\n  rawOutput = rawOutput[0].output || rawOutput[0];\n}\n\n// --- 3. PARSE THE PROFILES ARRAY ---\nlet profilesArray;\ntry {\n  profilesArray = extractJSON(rawOutput);\n  console.log('âœ“ Successfully extracted JSON');\n  console.log('Profiles array type:', Array.isArray(profilesArray) ? 'array' : typeof profilesArray);\n  console.log('Number of profiles:', Array.isArray(profilesArray) ? profilesArray.length : 'N/A');\n} catch (error) {\n  console.error('âœ— Failed to extract JSON:', error.message);\n  throw error;\n}\n\n// Ensure we have an array\nif (!Array.isArray(profilesArray)) {\n  // If it's a single profile, wrap it in an array\n  profilesArray = [profilesArray];\n}\n\nconsole.log(`âœ“ Processing ${profilesArray.length} profiles`);\n\n// --- 4. VALIDATE AND PROCESS EACH PROFILE ---\nconst supabaseRecords = [];\n\nfor (let i = 0; i < profilesArray.length; i++) {\n  const profile = profilesArray[i];\n  console.log(`\\n--- Processing Profile ${i + 1}/${profilesArray.length} ---`);\n  \n  // Validate required fields\n  const requiredFields = ['student_id', 'context_key', 'short_profile'];\n  const missingFields = requiredFields.filter(field => !profile[field]);\n  \n  if (missingFields.length > 0) {\n    console.warn(`âš  Skipping profile ${i + 1}: Missing fields: ${missingFields.join(', ')}`);\n    continue;\n  }\n  \n  if (typeof profile.short_profile !== 'object') {\n    console.warn(`âš  Skipping profile ${i + 1}: short_profile is not an object`);\n    continue;\n  }\n  \n  console.log('âœ“ Profile validated');\n  console.log('  Student ID:', profile.student_id);\n  console.log('  Context:', profile.context_key);\n  \n  // Deep clean all text content\n  const cleanedShortProfile = deepCleanObject(profile.short_profile);\n  const cleanedSummary = cleanText(profile.summary_text || profile.short_profile.quick_summary);\n  \n  // Build final record\n  const generatorMeta = {\n    llm_version: cleanedShortProfile.llm_version || 'gpt-4o-short_v1',\n    generated_at: cleanedShortProfile.generated_at || new Date().toISOString(),\n    workflow_id: $workflow.id || null,\n    execution_id: $execution.id || null,\n    processing_timestamp: new Date().toISOString(),\n    score_confidence: cleanedShortProfile.score_confidence || null\n  };\n  \n  const supabaseRecord = {\n    student_id: profile.student_id,\n    context_key: profile.context_key,\n    short_profile: cleanedShortProfile,\n    summary_text: cleanedSummary,\n    generator_meta: generatorMeta\n  };\n  \n  supabaseRecords.push(supabaseRecord);\n  console.log('âœ“ Record prepared for:', profile.context_key);\n}\n\nconsole.log('\\n=== Parse Short Profile - SUMMARY ===');\nconsole.log('Total profiles processed:', supabaseRecords.length);\nconsole.log('Contexts:', supabaseRecords.map(r => r.context_key).join(', '));\nconsole.log('âœ“ Parse complete');\n\n// Return array of records - each will be inserted separately\nreturn supabaseRecords.map(record => ({ json: record }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        400
      ],
      "id": "7e778ae9-7d27-41e9-95ea-f181275cdd53",
      "name": "Parse Short Profile"
    },
    {
      "parameters": {
        "tableId": "student_profiles_short",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "student_id",
              "fieldValue": "={{ $json.student_id }}"
            },
            {
              "fieldId": "context_key",
              "fieldValue": "={{ $json.context_key }}"
            },
            {
              "fieldId": "short_profile",
              "fieldValue": "={{ $json.short_profile }}"
            },
            {
              "fieldId": "summary_text",
              "fieldValue": "={{ $json.summary_text }}"
            },
            {
              "fieldId": "generator_meta",
              "fieldValue": "={{ $json.generator_meta }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        960,
        400
      ],
      "id": "55331ce2-e09d-4161-8a19-a23389ccc4f6",
      "name": "Add Short Profile"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.data.session_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        640,
        592
      ],
      "id": "f862766a-6442-4336-844f-fb1e555e54b5",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f9d7b8ee-8cf9-478a-a56e-fba4d57fedb4",
              "leftValue": "={{ $json.body.data.form_type }}",
              "rightValue": "onboarding",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -688,
        -352
      ],
      "id": "9124ff37-93f4-407c-b6b1-e5ef92b421e3",
      "name": "if onboarding"
    },
    {
      "parameters": {
        "content": "## Long profile generator ",
        "height": 768,
        "width": 2160,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1280,
        -464
      ],
      "typeVersion": 1,
      "id": "ac2866aa-05ce-4345-a3fb-27fb3cfab87a",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Short profile generator ",
        "height": 416,
        "width": 832,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        368,
        352
      ],
      "typeVersion": 1,
      "id": "58b5cb27-3e81-489f-a86e-885ab13e9c04",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "id": "59b63896-b230-4d3a-9031-7ed0cd85bf66",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        -1312,
        416
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "operation": "get",
        "documentURL": "https://docs.google.com/document/d/1aO0dNf8GUFRaNLzFjDV4Blnp2bn7Aq61j64RIwHfEi8/"
      },
      "id": "20e62d8e-b044-44b1-913a-dba33ee3a237",
      "name": "Get Document",
      "type": "n8n-nodes-base.googleDocs",
      "position": [
        -1152,
        416
      ],
      "typeVersion": 2,
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "8qhis65GMrcNAKf9",
          "name": "Google Docs account -cognigenai"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract full text from Google Doc\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const text = item.json.text || item.json.content || '';\n  \n  // Clean and prepare text\n  const cleanText = text.trim();\n  \n  outputItems.push({\n    json: {\n      fullText: cleanText,\n      documentId: item.json.documentId,\n      title: item.json.title || 'Untitled Document',\n      textLength: cleanText.length,\n      wordCount: cleanText.split(/\\s+/).length\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "08a980ac-4076-460e-9808-583a0147e22e",
      "name": "Extract and Prepare Text",
      "type": "n8n-nodes-base.code",
      "position": [
        -976,
        416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Create initial chunks for AI analysis\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const fullText = item.json.fullText;\n  const chunkSize = 1500; // Larger initial chunks for AI to analyze\n  const overlap = 300;\n  \n  const chunks = [];\n  \n  for (let i = 0; i < fullText.length; i += (chunkSize - overlap)) {\n    const start = i;\n    const end = Math.min(i + chunkSize, fullText.length);\n    const chunkText = fullText.substring(start, end);\n    \n    chunks.push({\n      text: chunkText,\n      start: start,\n      end: end,\n      chunkNumber: chunks.length + 1\n    });\n    \n    // Stop if we've reached the end\n    if (end >= fullText.length) break;\n  }\n  \n  outputItems.push({\n    json: {\n      fullText: fullText,\n      documentId: item.json.documentId,\n      documentTitle: item.json.title,\n      totalChunks: chunks.length,\n      chunks: chunks\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "05b3a917-af4a-45a0-a06b-9243422d3f1f",
      "name": "Break Into Initial Chunks",
      "type": "n8n-nodes-base.code",
      "position": [
        -768,
        416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Parse AI response and create final chunks for Supabase\n// Supabase Vector Store expects flat structure with pageContent and metadata\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  let aiResponse;\n  \n  try {\n    // Get the content from OpenAI response\n    if (Array.isArray(item.json) && item.json[0]?.message?.content) {\n      aiResponse = item.json[0].message.content;\n    } else if (item.json?.message?.content) {\n      aiResponse = item.json.message.content;\n    } else if (item.json?.content) {\n      aiResponse = item.json.content;\n    } else if (typeof item.json === 'object' && item.json.refinedChunks) {\n      aiResponse = item.json;\n    } else {\n      throw new Error('Unknown response format');\n    }\n    \n    if (!aiResponse.refinedChunks || !Array.isArray(aiResponse.refinedChunks)) {\n      throw new Error('Invalid response structure - missing refinedChunks array');\n    }\n    \n    const docData = $('Break Into Initial Chunks').first().json;\n    \n    // Create output items for each refined chunk\n    for (const chunk of aiResponse.refinedChunks) {\n      // Create a SINGLE flat object with all metadata as JSON string\n      const metadataObj = {\n        chunkId: chunk.chunkId,\n        totalChunks: aiResponse.totalChunks,\n        topic: chunk.topic,\n        importance: chunk.importance,\n        keywords: Array.isArray(chunk.keywords) ? chunk.keywords.join(', ') : '',\n        documentId: docData.documentId,\n        documentTitle: docData.documentTitle,\n        documentSummary: aiResponse.documentSummary,\n        chunkingMethod: 'agentic-ai-refined',\n        timestamp: new Date().toISOString()\n      };\n      \n      outputItems.push({\n        json: {\n          pageContent: chunk.text,\n          metadata: JSON.stringify(metadataObj) // Convert entire metadata to string\n        }\n      });\n    }\n    \n  } catch (e) {\n    console.error('AI parsing failed:', e.message);\n    \n    const docData = $('Break Into Initial Chunks').first().json;\n    \n    // Fallback to initial chunks\n    for (let i = 0; i < docData.chunks.length; i++) {\n      const chunk = docData.chunks[i];\n      \n      const metadataObj = {\n        chunkId: i + 1,\n        totalChunks: docData.totalChunks,\n        topic: 'Fallback chunk ' + (i + 1),\n        importance: 5,\n        keywords: '',\n        documentId: docData.documentId,\n        documentTitle: docData.documentTitle,\n        chunkingMethod: 'fallback-initial',\n        error: e.message,\n        timestamp: new Date().toISOString()\n      };\n      \n      outputItems.push({\n        json: {\n          pageContent: chunk.text,\n          metadata: JSON.stringify(metadataObj)\n        }\n      });\n    }\n  }\n}\n\nreturn outputItems;"
      },
      "id": "6edf453d-3b40-4d77-806e-13c11edfb131",
      "name": "Parse JSON Response",
      "type": "n8n-nodes-base.code",
      "position": [
        -288,
        416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "id"
        },
        "messages": {
          "values": [
            {
              "content": "=You are an expert document chunking AI. Your task is to analyze text chunks and refine their boundaries based on semantic meaning and topic changes. Always return ONLY valid JSON with no additional text or explanation.",
              "role": "system"
            },
            {
              "content": "=Analyze the following document chunks and create semantically coherent chunks with clear topic boundaries.\n\n**Document Title:** {{ $json.documentTitle }}\n**Total Initial Chunks:** {{ $json.totalChunks }}\n\n**Preliminary Chunks:**\n{{ JSON.stringify($json.chunks, null, 2) }}\n\n**Your Task:**\n1. Identify natural semantic boundaries (topic changes, section breaks, context shifts)\n2. Merge or split chunks as needed for semantic coherence\n3. Assign a descriptive topic to each chunk\n4. Rate importance (1-10) based on information density\n5. Extract 3-7 key terms/keywords per chunk\n\n**Required JSON Response Format:**\n```json\n{\n  \"refinedChunks\": [\n    {\n      \"chunkId\": 1,\n      \"text\": \"The actual refined chunk text\",\n      \"topic\": \"Brief descriptive topic\",\n      \"importance\": 8,\n      \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n    }\n  ],\n  \"totalChunks\": 5,\n  \"documentSummary\": \"A brief 1-2 sentence summary of the entire document\"\n}\n```\n\n**Important Rules:**\n- Return ONLY the JSON object, no markdown formatting, no explanatory text\n- Each chunk should be 500-2000 characters\n- Maintain all original content - don't lose any text\n- Ensure chunks don't overlap\n- Topic should be 3-8 words maximum\n- Keywords should be single words or short phrases"
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "maxTokens": 4000,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -592,
        416
      ],
      "id": "4c323fb4-c2b6-4878-a789-5c15eeb2259a",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "student_profiles_short_embeddings",
          "mode": "list",
          "cachedResultName": "student_profiles_short_embeddings"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        -112,
        416
      ],
      "id": "17579f14-2e37-49d1-8124-53864f899430",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "VKoabbJQnegsVFoB",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -144,
        576
      ],
      "id": "f4b5fcbf-fee4-4170-b895-03d6c2c24df0",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        48,
        576
      ],
      "id": "28fa33e9-845b-4680-830e-b4d531b22457",
      "name": "Default Data Loader"
    },
    {
      "parameters": {
        "operation": "get",
        "documentURL": "https://docs.google.com/document/d/1THSUbcjXP-njAX27oy3MmcfBxrFiFgrTBJvVatn0Lys/edit?usp=sharing"
      },
      "id": "d399af8e-b15a-403b-8cf9-f4195681898e",
      "name": "Get Long Profile Document",
      "type": "n8n-nodes-base.googleDocs",
      "position": [
        -1136,
        784
      ],
      "typeVersion": 2,
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "8qhis65GMrcNAKf9",
          "name": "Google Docs account -cognigenai"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "student_profiles_long_embeddings",
          "mode": "list",
          "cachedResultName": "student_profiles_long_embeddings"
        },
        "embeddingBatchSize": 1000,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        -96,
        784
      ],
      "id": "0fdca931-73f6-436a-9387-ad545af2bd88",
      "name": "Supabase Vector Store (Long)",
      "credentials": {
        "supabaseApi": {
          "id": "Q73MSqamXZ7oNsc2",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "id": "58c69dd2-2d64-4930-a585-03eb2967ead8",
      "name": "Schedule Trigger1",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        -1296,
        784
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "jsCode": "// Extract full text from Google Doc\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const text = item.json.text || item.json.content || '';\n  \n  // Clean and prepare text\n  const cleanText = text.trim();\n  \n  outputItems.push({\n    json: {\n      fullText: cleanText,\n      documentId: item.json.documentId,\n      title: item.json.title || 'Untitled Document',\n      textLength: cleanText.length,\n      wordCount: cleanText.split(/\\s+/).length\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "b0d6e6aa-33f1-4809-9eba-43f143c6e234",
      "name": "Extract and Prepare Text1",
      "type": "n8n-nodes-base.code",
      "position": [
        -960,
        784
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Create initial chunks for AI analysis\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const fullText = item.json.fullText;\n  const chunkSize = 1500; // Larger initial chunks for AI to analyze\n  const overlap = 300;\n  \n  const chunks = [];\n  \n  for (let i = 0; i < fullText.length; i += (chunkSize - overlap)) {\n    const start = i;\n    const end = Math.min(i + chunkSize, fullText.length);\n    const chunkText = fullText.substring(start, end);\n    \n    chunks.push({\n      text: chunkText,\n      start: start,\n      end: end,\n      chunkNumber: chunks.length + 1\n    });\n    \n    // Stop if we've reached the end\n    if (end >= fullText.length) break;\n  }\n  \n  outputItems.push({\n    json: {\n      fullText: fullText,\n      documentId: item.json.documentId,\n      documentTitle: item.json.title,\n      totalChunks: chunks.length,\n      chunks: chunks\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "3e29ff9d-6b02-4f3a-9672-4c883717312c",
      "name": "Break Into Initial Chunks1",
      "type": "n8n-nodes-base.code",
      "position": [
        -752,
        784
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Parse AI response and create final chunks for Supabase\n// Supabase Vector Store expects flat structure with pageContent and metadata\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  let aiResponse;\n  \n  try {\n    // Get the content from OpenAI response\n    if (Array.isArray(item.json) && item.json[0]?.message?.content) {\n      aiResponse = item.json[0].message.content;\n    } else if (item.json?.message?.content) {\n      aiResponse = item.json.message.content;\n    } else if (item.json?.content) {\n      aiResponse = item.json.content;\n    } else if (typeof item.json === 'object' && item.json.refinedChunks) {\n      aiResponse = item.json;\n    } else {\n      throw new Error('Unknown response format');\n    }\n    \n    if (!aiResponse.refinedChunks || !Array.isArray(aiResponse.refinedChunks)) {\n      throw new Error('Invalid response structure - missing refinedChunks array');\n    }\n    \n    const docData = $('Break Into Initial Chunks1').first().json;\n    \n    // Create output items for each refined chunk\n    for (const chunk of aiResponse.refinedChunks) {\n      // Create a SINGLE flat object with all metadata as JSON string\n      const metadataObj = {\n        chunkId: chunk.chunkId,\n        totalChunks: aiResponse.totalChunks,\n        topic: chunk.topic,\n        importance: chunk.importance,\n        keywords: Array.isArray(chunk.keywords) ? chunk.keywords.join(', ') : '',\n        documentId: docData.documentId,\n        documentTitle: docData.documentTitle,\n        documentSummary: aiResponse.documentSummary,\n        chunkingMethod: 'agentic-ai-refined',\n        timestamp: new Date().toISOString()\n      };\n      \n      outputItems.push({\n        json: {\n          pageContent: chunk.text,\n          metadata: JSON.stringify(metadataObj) // Convert entire metadata to string\n        }\n      });\n    }\n    \n  } catch (e) {\n    console.error('AI parsing failed:', e.message);\n    \n    const docData = $('Break Into Initial Chunks1').first().json;\n    \n    // Fallback to initial chunks\n    for (let i = 0; i < docData.chunks.length; i++) {\n      const chunk = docData.chunks[i];\n      \n      const metadataObj = {\n        chunkId: i + 1,\n        totalChunks: docData.totalChunks,\n        topic: 'Fallback chunk ' + (i + 1),\n        importance: 5,\n        keywords: '',\n        documentId: docData.documentId,\n        documentTitle: docData.documentTitle,\n        chunkingMethod: 'fallback-initial',\n        error: e.message,\n        timestamp: new Date().toISOString()\n      };\n      \n      outputItems.push({\n        json: {\n          pageContent: chunk.text,\n          metadata: JSON.stringify(metadataObj)\n        }\n      });\n    }\n  }\n}\n\nreturn outputItems;"
      },
      "id": "6e244f99-b5ba-4851-8e31-ec3930399c72",
      "name": "Parse JSON Response1",
      "type": "n8n-nodes-base.code",
      "position": [
        -272,
        784
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "id"
        },
        "messages": {
          "values": [
            {
              "content": "=You are an expert document chunking AI. Your task is to analyze text chunks and refine their boundaries based on semantic meaning and topic changes. Always return ONLY valid JSON with no additional text or explanation.",
              "role": "system"
            },
            {
              "content": "=Analyze the following document chunks and create semantically coherent chunks with clear topic boundaries.\n\n**Document Title:** {{ $json.documentTitle }}\n**Total Initial Chunks:** {{ $json.totalChunks }}\n\n**Preliminary Chunks:**\n{{ JSON.stringify($json.chunks, null, 2) }}\n\n**Your Task:**\n1. Identify natural semantic boundaries (topic changes, section breaks, context shifts)\n2. Merge or split chunks as needed for semantic coherence\n3. Assign a descriptive topic to each chunk\n4. Rate importance (1-10) based on information density\n5. Extract 3-7 key terms/keywords per chunk\n\n**Required JSON Response Format:**\n```json\n{\n  \"refinedChunks\": [\n    {\n      \"chunkId\": 1,\n      \"text\": \"The actual refined chunk text\",\n      \"topic\": \"Brief descriptive topic\",\n      \"importance\": 8,\n      \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n    }\n  ],\n  \"totalChunks\": 5,\n  \"documentSummary\": \"A brief 1-2 sentence summary of the entire document\"\n}\n```\n\n**Important Rules:**\n- Return ONLY the JSON object, no markdown formatting, no explanatory text\n- Each chunk should be 500-2000 characters\n- Maintain all original content - don't lose any text\n- Ensure chunks don't overlap\n- Topic should be 3-8 words maximum\n- Keywords should be single words or short phrases"
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "maxTokens": 4000,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -576,
        784
      ],
      "id": "6adfb503-bcd8-4453-869d-5ee91edd8586",
      "name": "Message a model1",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -128,
        928
      ],
      "id": "f27e1624-698b-4998-8bf4-4b5697d23df2",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        48,
        928
      ],
      "id": "032597fa-d9fe-4ada-80bc-f57d173b6191",
      "name": "Default Data Loader1"
    },
    {
      "parameters": {
        "content": "## Short profile DOC to Vector DB\n",
        "height": 352,
        "width": 1600,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1360,
        336
      ],
      "typeVersion": 1,
      "id": "e706b15b-54ef-4d2a-a82c-76abe1cddbfa",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Short profile  DOC to Vector DB",
        "height": 352,
        "width": 1600,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1360,
        704
      ],
      "typeVersion": 1,
      "id": "7d2623af-9820-40d2-89e0-57a725b2ffa6",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=INPUT DATA:\n{{ JSON.stringify($json.data, null, 2) }}",
        "options": {
          "systemMessage": "=You are an expert fitness coach creating quick-reference profiles for class instruction.\n\nðŸš¨ CRITICAL WORKFLOW - YOU MUST FOLLOW THESE STEPS IN ORDER:\n\nSTEP 1: DISCOVER ALL WORKOUT FORMATS (MANDATORY)\nBefore generating ANY profiles, you MUST:\n1. Use the search_knowledge_base tool to search for \"all workout format contexts\"\n2. Search for \"student profile structure examples\"\n3. Review the retrieved examples to identify ALL unique context_key values\n4. Make a list of every distinct workout format found in the knowledge base\n\nExample searches you MUST perform:\n- \"workout format contexts\"\n- \"student profile structure\"\n- \"coaching guidelines all formats\"\n- \"class type profiles\"\n\nSTEP 2: ANALYZE RETRIEVED DATA\nReview all search results and note:\n- ALL unique context_key values found (e.g., \"strength_upper\", \"yoga\", \"pilates\", etc.)\n- Common terminology used in existing profiles\n- Structure patterns in must_know, should_know, nice_to_know arrays\n- Format-specific coaching tips\n- Confidence score ranges\n\nSTEP 3: GENERATE PROFILES DYNAMICALLY\nCreate ONE profile for EACH unique context_key found in Step 1, incorporating:\n- Terminology from retrieved documents\n- Structure patterns from examples\n- Best practices from knowledge base\n- Format-specific guidance for each context\n\nSTEP 4: RETURN JSON\nReturn pure JSON array with ALL profiles (not just 9, but however many contexts exist).\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nABSOLUTE OUTPUT REQUIREMENT\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nAfter completing your searches and analysis, you MUST return ONLY valid JSON. Nothing else.\n\nâŒ FORBIDDEN - DO NOT INCLUDE:\n- Markdown code blocks (```json or ```)\n- Any text before the JSON\n- Any text after the JSON\n- Any explanatory comments\n- Search summaries or analysis\n- Any line breaks before or after JSON\n\nâœ… REQUIRED FORMAT:\n- Start immediately with [\n- End immediately with ]\n- Pure JSON array in between\n- No whitespace before [\n- No whitespace after ]\n\nDYNAMIC PROFILE GENERATION:\nYou MUST create profiles for ALL unique context_key values found in the knowledge base.\nDo NOT limit yourself to a fixed number. Generate as many profiles as there are workout formats.\n\nEach profile object MUST have this structure (4 top-level keys):\n{\n  \"student_id\": \"uuid-string\",\n  \"context_key\": \"format-name-from-knowledge-base\",\n  \"short_profile\": {\n    \"generated_at\": \"ISO-8601-timestamp\",\n    \"llm_version\": \"gpt-4o-short_v1\",\n    \"context\": \"same-as-context_key\",\n    \"must_know\": [\"array\", \"of\", \"strings\"],\n    \"should_know\": [\"array\", \"of\", \"strings\"],\n    \"nice_to_know\": [\"array\", \"of\", \"strings\"],\n    \"class_actionable_tips\": [\n      {\n        \"tip\": \"string\",\n        \"urgency\": \"high|medium|low\",\n        \"rationale\": \"string\"\n      }\n    ],\n    \"quick_summary\": \"string-under-100-chars\",\n    \"score_confidence\": 0.0-to-1.0\n  },\n  \"summary_text\": \"string-100-to-150-words\"\n}\n\nFORMAT-SPECIFIC GUIDANCE (Use knowledge base data as primary source):\n\nFor each workout format found in the knowledge base, extract:\n\nMUST_KNOW (Critical Safety):\n- Pain points and restrictions specific to this format\n- Injury risks for movements in this class type\n- Required modifications for this workout style\n- Bilateral imbalances >20% relevant to this format\n\nSHOULD_KNOW (Performance):\n- Key strengths to leverage in this format\n- Compensatory patterns to cue during this class type\n- Priority training focuses for this workout style\n\nNICE_TO_KNOW (Personalization):\n- Goals and preferences related to this format\n- Exercise likes/dislikes for this class type\n\nCLASS_ACTIONABLE_TIPS (2-4 tips per format):\n{\n  \"tip\": \"Specific coaching cue for this exact workout format\",\n  \"urgency\": \"high|medium|low\",\n  \"rationale\": \"Why this matters for this specific format\"\n}\n\nQUICK_SUMMARY:\nMaximum 100 characters for roster display, format-specific.\n\nSCORE_CONFIDENCE:\n0.9-1.0 = Comprehensive data\n0.7-0.8 = Good data, minor gaps\n0.5-0.6 = Limited data\n<0.5 = Insufficient data\n\nSUMMARY_TEXT:\n100-150 word paragraph covering the format-specific considerations.\n\nYOUR RESPONSE MUST:\n- Start with [\n- End with ]\n- Contain profile objects for ALL unique context_key values found\n- Each object must have valid context_key from the knowledge base\n- Be pure JSON with no markdown or extra text\n- Match patterns and structures found in Supabase vector store\n\nNOTHING BEFORE. NOTHING AFTER. JUST JSON ARRAY."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        480,
        400
      ],
      "id": "7332fc0d-d10d-4188-b695-715db8806097",
      "name": "Student Short Profile",
      "alwaysOutputData": false
    }
  ],
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Long Profile Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If assessment": {
      "main": [
        [
          {
            "node": "Transform Assesment Form",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If feedback": {
      "main": [
        [
          {
            "node": "Transform Feedback Form",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Body Only": {
      "main": [
        [
          {
            "node": "If assessment",
            "type": "main",
            "index": 0
          },
          {
            "node": "If feedback",
            "type": "main",
            "index": 0
          },
          {
            "node": "if onboarding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Onboarding Form": {
      "main": [
        [
          {
            "node": "Extract Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Assesment Form": {
      "main": [
        [
          {
            "node": "Extract Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Feedback Form": {
      "main": [
        [
          {
            "node": "Extract Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Long Profile Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Set Body Only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Long Profile Agent": {
      "main": [
        [
          {
            "node": "Parse Long Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Required Fields": {
      "main": [
        [
          {
            "node": "Long Profile Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Long Profile": {
      "main": [
        [
          {
            "node": "Add Long Profile",
            "type": "main",
            "index": 0
          },
          {
            "node": "Student Short Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store2": {
      "ai_tool": [
        [
          {
            "node": "Long Profile Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI2": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store2",
            "type": "ai_embedding",
            "index": 0
          },
          {
            "node": "search_knowledge_base",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "search_knowledge_base": {
      "ai_tool": [
        [
          {
            "node": "Student Short Profile",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Student Short Profile",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "Student Short Profile",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "if onboarding": {
      "main": [
        [
          {
            "node": "Transform Onboarding Form",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Short Profile": {
      "main": [
        [
          {
            "node": "Add Short Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Get Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Document": {
      "main": [
        [
          {
            "node": "Extract and Prepare Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract and Prepare Text": {
      "main": [
        [
          {
            "node": "Break Into Initial Chunks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Break Into Initial Chunks": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse JSON Response": {
      "main": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Parse JSON Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Get Long Profile Document": {
      "main": [
        [
          {
            "node": "Extract and Prepare Text1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger1": {
      "main": [
        [
          {
            "node": "Get Long Profile Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract and Prepare Text1": {
      "main": [
        [
          {
            "node": "Break Into Initial Chunks1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Break Into Initial Chunks1": {
      "main": [
        [
          {
            "node": "Message a model1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse JSON Response1": {
      "main": [
        [
          {
            "node": "Supabase Vector Store (Long)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model1": {
      "main": [
        [
          {
            "node": "Parse JSON Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store (Long)",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader1": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store (Long)",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Student Short Profile": {
      "main": [
        [
          {
            "node": "Parse Short Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "fitwithparirp.app.n8n.cloud",
            "user-agent": "PostmanRuntime/7.49.0",
            "content-length": "39249",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "2401:4900:1c5b:487a:b157:4b99:ed8f:40e6",
            "cf-ew-via": "15",
            "cf-ipcountry": "IN",
            "cf-ray": "9938cf0fa6dca7a0-DEL",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "content-type": "application/json",
            "postman-token": "360c5599-25a9-4a47-8883-881a0854962e",
            "x-forwarded-for": "2401:4900:1c5b:487a:b157:4b99:ed8f:40e6, 162.158.142.65",
            "x-forwarded-host": "fitwithparirp.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-9-7bb7d4c57c-kbbb2",
            "x-is-trusted": "yes",
            "x-real-ip": "2401:4900:1c5b:487a:b157:4b99:ed8f:40e6"
          },
          "params": {},
          "query": {},
          "body": {
            "success": true,
            "session_id": "123432",
            "data": {
              "form_type": "onboarding",
              "assessment": {
                "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                "session_id": "c7d8e9f0-1a2b-3c4d-5e6f-7890abcdef12",
                "student_id": "550e8400-e29b-41d4-a716-446655440000",
                "coach_id": "660e8400-e29b-41d4-a716-446655440001",
                "status": "completed",
                "created_at": "2025-10-23T09:00:00Z",
                "updated_at": "2025-10-23T09:45:00Z",
                "completed_at": "2025-10-23T09:45:00Z",
                "student": {
                  "id": "550e8400-e29b-41d4-a716-446655440000",
                  "full_name": "Sarah Johnson",
                  "email": "sarah.johnson@example.com",
                  "avatar_url": "https://example.com/avatars/sarah.jpg",
                  "date_of_birth": "1992-05-15",
                  "gender": "female",
                  "fitness_goal": "Improve overall strength and mobility"
                },
                "coach": {
                  "id": "660e8400-e29b-41d4-a716-446655440001",
                  "full_name": "Dr. Mike Martinez",
                  "email": "mike.martinez@fitwithpari.com",
                  "avatar_url": "https://example.com/avatars/mike.jpg",
                  "bio": "Certified Strength & Conditioning Specialist with 10 years of experience",
                  "specialties": [
                    "Movement Assessment",
                    "Corrective Exercise",
                    "Sports Performance"
                  ]
                }
              },
              "test_results": [
                {
                  "id": "tr-001-overhead-squat",
                  "assessment_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "test_id": "test-overhead-squat",
                  "test_name": "Overhead Squat Assessment",
                  "test_description": "Evaluates overall body mechanics, mobility, and stability during a fundamental movement pattern",
                  "test_category": "movement_screening",
                  "display_order": 1,
                  "status": "completed",
                  "completed_at": "2025-10-23T09:15:00Z",
                  "created_at": "2025-10-23T09:10:00Z",
                  "updated_at": "2025-10-23T09:15:00Z",
                  "metadata": {
                    "duration_seconds": 300,
                    "video_count": 2,
                    "repetitions_performed": 5,
                    "test_protocol": "NASM Overhead Squat Assessment"
                  },
                  "questions": [
                    {
                      "id": "q-os-001",
                      "test_id": "test-overhead-squat",
                      "question_text": "Does the client's feet turn out during the movement?",
                      "question_type": "binary",
                      "is_required": true,
                      "display_order": 1,
                      "help_text": "Observe if feet externally rotate (point outward) during the squat",
                      "validation_rules": {
                        "required": true
                      },
                      "metadata": {
                        "body_region": "lower_body",
                        "movement_phase": "descent",
                        "compensation_pattern": "foot_pronation"
                      },
                      "response": {
                        "id": "resp-os-001",
                        "question_id": "q-os-001",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": true,
                        "created_at": "2025-10-23T09:12:00Z",
                        "updated_at": "2025-10-23T09:12:00Z"
                      }
                    },
                    {
                      "id": "q-os-002",
                      "test_id": "test-overhead-squat",
                      "question_text": "Does the client's knees move inward (valgus collapse)?",
                      "question_type": "ternary",
                      "is_required": true,
                      "display_order": 2,
                      "help_text": "Check for medial knee displacement during squat",
                      "options": [
                        {
                          "value": "none",
                          "label": "No valgus",
                          "score": 0
                        },
                        {
                          "value": "mild",
                          "label": "Mild valgus",
                          "score": 1
                        },
                        {
                          "value": "severe",
                          "label": "Severe valgus",
                          "score": 2
                        }
                      ],
                      "validation_rules": {
                        "required": true,
                        "enum": [
                          "none",
                          "mild",
                          "severe"
                        ]
                      },
                      "metadata": {
                        "body_region": "lower_body",
                        "movement_phase": "descent",
                        "compensation_pattern": "knee_valgus"
                      },
                      "response": {
                        "id": "resp-os-002",
                        "question_id": "q-os-002",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": "mild",
                        "created_at": "2025-10-23T09:12:30Z",
                        "updated_at": "2025-10-23T09:12:30Z"
                      }
                    },
                    {
                      "id": "q-os-003",
                      "test_id": "test-overhead-squat",
                      "question_text": "Maximum squat depth achieved (inches from floor to hip joint)",
                      "question_type": "numeric",
                      "is_required": true,
                      "display_order": 3,
                      "help_text": "Measure the vertical distance from floor to the greater trochanter at lowest point",
                      "validation_rules": {
                        "required": true,
                        "min": 0,
                        "max": 48,
                        "unit": "inches"
                      },
                      "metadata": {
                        "body_region": "lower_body",
                        "movement_phase": "bottom_position",
                        "measurement_type": "depth"
                      },
                      "response": {
                        "id": "resp-os-003",
                        "question_id": "q-os-003",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": 18.5,
                        "created_at": "2025-10-23T09:13:00Z",
                        "updated_at": "2025-10-23T09:13:00Z"
                      }
                    },
                    {
                      "id": "q-os-004",
                      "test_id": "test-overhead-squat",
                      "question_text": "Time to complete 5 repetitions",
                      "question_type": "duration",
                      "is_required": true,
                      "display_order": 4,
                      "help_text": "Record total time for 5 controlled repetitions",
                      "validation_rules": {
                        "required": true,
                        "min_seconds": 10,
                        "max_seconds": 120
                      },
                      "metadata": {
                        "measurement_type": "tempo",
                        "repetitions": 5
                      },
                      "response": {
                        "id": "resp-os-004",
                        "question_id": "q-os-004",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": 45,
                        "created_at": "2025-10-23T09:14:00Z",
                        "updated_at": "2025-10-23T09:14:00Z"
                      }
                    },
                    {
                      "id": "q-os-005",
                      "test_id": "test-overhead-squat",
                      "question_text": "Overall movement quality rating",
                      "question_type": "scale_4",
                      "is_required": true,
                      "display_order": 5,
                      "help_text": "Rate the overall quality of the movement pattern",
                      "options": [
                        {
                          "value": "poor",
                          "label": "Poor - Multiple compensations",
                          "score": 1
                        },
                        {
                          "value": "fair",
                          "label": "Fair - Some compensations",
                          "score": 2
                        },
                        {
                          "value": "good",
                          "label": "Good - Minor compensations",
                          "score": 3
                        },
                        {
                          "value": "excellent",
                          "label": "Excellent - No compensations",
                          "score": 4
                        }
                      ],
                      "validation_rules": {
                        "required": true,
                        "enum": [
                          "poor",
                          "fair",
                          "good",
                          "excellent"
                        ]
                      },
                      "metadata": {
                        "assessment_type": "qualitative"
                      },
                      "response": {
                        "id": "resp-os-005",
                        "question_id": "q-os-005",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": "fair",
                        "created_at": "2025-10-23T09:14:30Z",
                        "updated_at": "2025-10-23T09:14:30Z"
                      }
                    },
                    {
                      "id": "q-os-006",
                      "test_id": "test-overhead-squat",
                      "question_text": "Additional observations or notes",
                      "question_type": "textarea",
                      "is_required": false,
                      "display_order": 6,
                      "help_text": "Record any additional observations, limitations, or concerns",
                      "validation_rules": {
                        "max_length": 1000
                      },
                      "metadata": {
                        "field_type": "notes"
                      },
                      "response": {
                        "id": "resp-os-006",
                        "question_id": "q-os-006",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": "Client shows good effort but limited ankle dorsiflexion. Recommend adding ankle mobility work to program. Also noted some upper back rounding during descent.",
                        "created_at": "2025-10-23T09:15:00Z",
                        "updated_at": "2025-10-23T09:15:00Z"
                      }
                    }
                  ],
                  "media_files": [
                    {
                      "id": "media-os-001",
                      "test_result_id": "tr-001-overhead-squat",
                      "file_type": "video",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/overhead-squat-front.mp4",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/overhead-squat-front-thumb.jpg",
                      "file_size_bytes": 15728640,
                      "duration_seconds": 30,
                      "view_angle": "anterior",
                      "caption": "Overhead Squat - Front View",
                      "created_at": "2025-10-23T09:11:00Z",
                      "metadata": {
                        "resolution": "1920x1080",
                        "fps": 30,
                        "codec": "h264"
                      }
                    },
                    {
                      "id": "media-os-002",
                      "test_result_id": "tr-001-overhead-squat",
                      "file_type": "video",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/overhead-squat-side.mp4",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/overhead-squat-side-thumb.jpg",
                      "file_size_bytes": 16777216,
                      "duration_seconds": 30,
                      "view_angle": "lateral",
                      "caption": "Overhead Squat - Side View",
                      "created_at": "2025-10-23T09:11:30Z",
                      "metadata": {
                        "resolution": "1920x1080",
                        "fps": 30,
                        "codec": "h264"
                      }
                    }
                  ]
                },
                {
                  "id": "tr-002-balance-left",
                  "assessment_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "test_id": "test-single-leg-balance",
                  "test_name": "Single Leg Balance Test - Left Leg",
                  "test_description": "Assesses unilateral balance and stability",
                  "test_category": "balance",
                  "display_order": 2,
                  "status": "completed",
                  "completed_at": "2025-10-23T09:25:00Z",
                  "created_at": "2025-10-23T09:20:00Z",
                  "updated_at": "2025-10-23T09:25:00Z",
                  "metadata": {
                    "duration_seconds": 180,
                    "video_count": 1,
                    "test_side": "left",
                    "test_protocol": "Eyes Open Single Leg Stance"
                  },
                  "questions": [
                    {
                      "id": "q-bal-001",
                      "test_id": "test-single-leg-balance",
                      "question_text": "Maximum balance time achieved (seconds)",
                      "question_type": "duration",
                      "is_required": true,
                      "display_order": 1,
                      "help_text": "Record how long the client maintained single leg stance without touching down",
                      "validation_rules": {
                        "required": true,
                        "min_seconds": 0,
                        "max_seconds": 60
                      },
                      "metadata": {
                        "measurement_type": "endurance",
                        "test_side": "left"
                      },
                      "response": {
                        "id": "resp-bal-001",
                        "question_id": "q-bal-001",
                        "test_result_id": "tr-002-balance-left",
                        "response": 23,
                        "created_at": "2025-10-23T09:23:00Z",
                        "updated_at": "2025-10-23T09:23:00Z"
                      }
                    },
                    {
                      "id": "q-bal-002",
                      "test_id": "test-single-leg-balance",
                      "question_text": "Compensations observed",
                      "question_type": "multiselect",
                      "is_required": false,
                      "display_order": 2,
                      "help_text": "Select all compensatory movements observed during the test",
                      "options": [
                        {
                          "value": "hip_hike",
                          "label": "Hip hike"
                        },
                        {
                          "value": "trunk_lean",
                          "label": "Trunk lean"
                        },
                        {
                          "value": "arm_flailing",
                          "label": "Arm flailing"
                        },
                        {
                          "value": "excessive_sway",
                          "label": "Excessive sway"
                        },
                        {
                          "value": "foot_adjustment",
                          "label": "Foot adjustments"
                        },
                        {
                          "value": "none",
                          "label": "No compensations"
                        }
                      ],
                      "validation_rules": {
                        "min_selections": 0,
                        "max_selections": 6
                      },
                      "metadata": {
                        "assessment_type": "qualitative"
                      },
                      "response": {
                        "id": "resp-bal-002",
                        "question_id": "q-bal-002",
                        "test_result_id": "tr-002-balance-left",
                        "response": [
                          "hip_hike",
                          "arm_flailing"
                        ],
                        "created_at": "2025-10-23T09:24:00Z",
                        "updated_at": "2025-10-23T09:24:00Z"
                      }
                    }
                  ],
                  "media_files": [
                    {
                      "id": "media-bal-001",
                      "test_result_id": "tr-002-balance-left",
                      "file_type": "video",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/balance-left.mp4",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/balance-left-thumb.jpg",
                      "file_size_bytes": 8388608,
                      "duration_seconds": 25,
                      "view_angle": "anterior",
                      "caption": "Single Leg Balance - Left Leg",
                      "created_at": "2025-10-23T09:22:00Z",
                      "metadata": {
                        "resolution": "1920x1080",
                        "fps": 30,
                        "codec": "h264"
                      }
                    }
                  ]
                },
                {
                  "id": "tr-003-balance-right",
                  "assessment_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "test_id": "test-single-leg-balance",
                  "test_name": "Single Leg Balance Test - Right Leg",
                  "test_description": "Assesses unilateral balance and stability",
                  "test_category": "balance",
                  "display_order": 3,
                  "status": "completed",
                  "completed_at": "2025-10-23T09:32:00Z",
                  "created_at": "2025-10-23T09:28:00Z",
                  "updated_at": "2025-10-23T09:32:00Z",
                  "metadata": {
                    "duration_seconds": 180,
                    "video_count": 1,
                    "test_side": "right",
                    "test_protocol": "Eyes Open Single Leg Stance"
                  },
                  "questions": [
                    {
                      "id": "q-bal-001",
                      "test_id": "test-single-leg-balance",
                      "question_text": "Maximum balance time achieved (seconds)",
                      "question_type": "duration",
                      "is_required": true,
                      "display_order": 1,
                      "help_text": "Record how long the client maintained single leg stance without touching down",
                      "validation_rules": {
                        "required": true,
                        "min_seconds": 0,
                        "max_seconds": 60
                      },
                      "metadata": {
                        "measurement_type": "endurance",
                        "test_side": "right"
                      },
                      "response": {
                        "id": "resp-bal-003",
                        "question_id": "q-bal-001",
                        "test_result_id": "tr-003-balance-right",
                        "response": 40,
                        "created_at": "2025-10-23T09:30:00Z",
                        "updated_at": "2025-10-23T09:30:00Z"
                      }
                    },
                    {
                      "id": "q-bal-002",
                      "test_id": "test-single-leg-balance",
                      "question_text": "Compensations observed",
                      "question_type": "multiselect",
                      "is_required": false,
                      "display_order": 2,
                      "help_text": "Select all compensatory movements observed during the test",
                      "options": [
                        {
                          "value": "hip_hike",
                          "label": "Hip hike"
                        },
                        {
                          "value": "trunk_lean",
                          "label": "Trunk lean"
                        },
                        {
                          "value": "arm_flailing",
                          "label": "Arm flailing"
                        },
                        {
                          "value": "excessive_sway",
                          "label": "Excessive sway"
                        },
                        {
                          "value": "foot_adjustment",
                          "label": "Foot adjustments"
                        },
                        {
                          "value": "none",
                          "label": "No compensations"
                        }
                      ],
                      "validation_rules": {
                        "min_selections": 0,
                        "max_selections": 6
                      },
                      "metadata": {
                        "assessment_type": "qualitative"
                      },
                      "response": {
                        "id": "resp-bal-004",
                        "question_id": "q-bal-002",
                        "test_result_id": "tr-003-balance-right",
                        "response": [
                          "none"
                        ],
                        "created_at": "2025-10-23T09:31:00Z",
                        "updated_at": "2025-10-23T09:31:00Z"
                      }
                    }
                  ],
                  "media_files": [
                    {
                      "id": "media-bal-002",
                      "test_result_id": "tr-003-balance-right",
                      "file_type": "video",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/balance-right.mp4",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/balance-right-thumb.jpg",
                      "file_size_bytes": 9437184,
                      "duration_seconds": 42,
                      "view_angle": "anterior",
                      "caption": "Single Leg Balance - Right Leg",
                      "created_at": "2025-10-23T09:29:00Z",
                      "metadata": {
                        "resolution": "1920x1080",
                        "fps": 30,
                        "codec": "h264"
                      }
                    }
                  ]
                },
                {
                  "id": "tr-004-shoulder-mob",
                  "assessment_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "test_id": "test-shoulder-mobility",
                  "test_name": "Shoulder Mobility Assessment",
                  "test_description": "Evaluates shoulder range of motion and mobility patterns",
                  "test_category": "mobility",
                  "display_order": 4,
                  "status": "completed",
                  "completed_at": "2025-10-23T09:42:00Z",
                  "created_at": "2025-10-23T09:35:00Z",
                  "updated_at": "2025-10-23T09:42:00Z",
                  "metadata": {
                    "duration_seconds": 240,
                    "video_count": 0,
                    "image_count": 1,
                    "test_protocol": "Shoulder Flexion ROM"
                  },
                  "questions": [
                    {
                      "id": "q-sh-001",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Shoulder flexion range of motion - Right (degrees)",
                      "question_type": "numeric",
                      "is_required": true,
                      "display_order": 1,
                      "help_text": "Measure active shoulder flexion using goniometer",
                      "validation_rules": {
                        "required": true,
                        "min": 0,
                        "max": 180,
                        "unit": "degrees"
                      },
                      "metadata": {
                        "body_region": "upper_body",
                        "movement_type": "flexion",
                        "test_side": "right"
                      },
                      "response": {
                        "id": "resp-sh-001",
                        "question_id": "q-sh-001",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": 145,
                        "created_at": "2025-10-23T09:38:00Z",
                        "updated_at": "2025-10-23T09:38:00Z"
                      }
                    },
                    {
                      "id": "q-sh-002",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Shoulder flexion range of motion - Left (degrees)",
                      "question_type": "numeric",
                      "is_required": true,
                      "display_order": 2,
                      "help_text": "Measure active shoulder flexion using goniometer",
                      "validation_rules": {
                        "required": true,
                        "min": 0,
                        "max": 180,
                        "unit": "degrees"
                      },
                      "metadata": {
                        "body_region": "upper_body",
                        "movement_type": "flexion",
                        "test_side": "left"
                      },
                      "response": {
                        "id": "resp-sh-002",
                        "question_id": "q-sh-002",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": 175,
                        "created_at": "2025-10-23T09:39:00Z",
                        "updated_at": "2025-10-23T09:39:00Z"
                      }
                    },
                    {
                      "id": "q-sh-003",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Pain level during movement",
                      "question_type": "scale_severity",
                      "is_required": true,
                      "display_order": 3,
                      "help_text": "Rate pain during shoulder flexion (0 = no pain, 10 = severe pain)",
                      "options": [
                        {
                          "value": 0,
                          "label": "No pain"
                        },
                        {
                          "value": 1,
                          "label": "Minimal"
                        },
                        {
                          "value": 2,
                          "label": "Minimal"
                        },
                        {
                          "value": 3,
                          "label": "Mild"
                        },
                        {
                          "value": 4,
                          "label": "Mild"
                        },
                        {
                          "value": 5,
                          "label": "Moderate"
                        },
                        {
                          "value": 6,
                          "label": "Moderate"
                        },
                        {
                          "value": 7,
                          "label": "Severe"
                        },
                        {
                          "value": 8,
                          "label": "Severe"
                        },
                        {
                          "value": 9,
                          "label": "Very severe"
                        },
                        {
                          "value": 10,
                          "label": "Worst possible"
                        }
                      ],
                      "validation_rules": {
                        "required": true,
                        "min": 0,
                        "max": 10
                      },
                      "metadata": {
                        "scale_type": "pain"
                      },
                      "response": {
                        "id": "resp-sh-003",
                        "question_id": "q-sh-003",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": 2,
                        "created_at": "2025-10-23T09:40:00Z",
                        "updated_at": "2025-10-23T09:40:00Z"
                      }
                    },
                    {
                      "id": "q-sh-004",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Quality of movement",
                      "question_type": "select",
                      "is_required": true,
                      "display_order": 4,
                      "help_text": "Assess the overall quality of the shoulder flexion movement",
                      "options": [
                        {
                          "value": "smooth",
                          "label": "Smooth and controlled"
                        },
                        {
                          "value": "hesitant",
                          "label": "Hesitant but controlled"
                        },
                        {
                          "value": "compensated",
                          "label": "Movement with compensations"
                        },
                        {
                          "value": "restricted",
                          "label": "Significantly restricted"
                        }
                      ],
                      "validation_rules": {
                        "required": true,
                        "enum": [
                          "smooth",
                          "hesitant",
                          "compensated",
                          "restricted"
                        ]
                      },
                      "metadata": {
                        "assessment_type": "qualitative"
                      },
                      "response": {
                        "id": "resp-sh-004",
                        "question_id": "q-sh-004",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": "compensated",
                        "created_at": "2025-10-23T09:41:00Z",
                        "updated_at": "2025-10-23T09:41:00Z"
                      }
                    },
                    {
                      "id": "q-sh-005",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Clinical notes",
                      "question_type": "textarea",
                      "is_required": false,
                      "display_order": 5,
                      "help_text": "Additional observations about shoulder mobility",
                      "validation_rules": {
                        "max_length": 1000
                      },
                      "metadata": {
                        "field_type": "notes"
                      },
                      "response": {
                        "id": "resp-sh-005",
                        "question_id": "q-sh-005",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": "Patient reports mild discomfort in right shoulder at end range. Notable scapular winging on right side. Recommend rotator cuff strengthening and scapular stabilization exercises.",
                        "created_at": "2025-10-23T09:42:00Z",
                        "updated_at": "2025-10-23T09:42:00Z"
                      }
                    }
                  ],
                  "media_files": [
                    {
                      "id": "media-sh-001",
                      "test_result_id": "tr-004-shoulder-mob",
                      "file_type": "image",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/shoulder-rom-measurement.jpg",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/shoulder-rom-measurement-thumb.jpg",
                      "file_size_bytes": 2097152,
                      "view_angle": "lateral",
                      "caption": "Goniometer measurement - Right shoulder flexion",
                      "created_at": "2025-10-23T09:38:30Z",
                      "metadata": {
                        "resolution": "3024x4032",
                        "format": "jpeg"
                      }
                    }
                  ]
                }
              ],
              "summary": {
                "total_tests": 4,
                "completed_tests": 4,
                "total_questions": 16,
                "answered_questions": 16,
                "total_media_files": 5,
                "bilateral_comparisons": [
                  {
                    "test_name": "Single Leg Balance Test",
                    "metric": "Balance Duration",
                    "left_value": 23,
                    "right_value": 40,
                    "unit": "seconds",
                    "difference": 17,
                    "percent_difference": "42.5%",
                    "interpretation": "Right leg shows significantly better balance. Consider left leg strengthening."
                  },
                  {
                    "test_name": "Shoulder Mobility Assessment",
                    "metric": "Shoulder Flexion ROM",
                    "left_value": 175,
                    "right_value": 145,
                    "unit": "degrees",
                    "difference": 30,
                    "percent_difference": "17.1%",
                    "interpretation": "Right shoulder shows limited ROM. Recommend mobility work and investigation of underlying causes."
                  }
                ],
                "key_findings": [
                  "Overhead squat shows mild knee valgus and limited ankle mobility",
                  "Significant bilateral balance deficit (42.5% difference) favoring right leg",
                  "Right shoulder mobility limited to 145Â° (normal: 170-180Â°)",
                  "Minimal pain reported during shoulder movement (2/10)",
                  "Multiple compensatory patterns observed during movement screening"
                ],
                "recommendations": [
                  "Ankle mobility exercises (calf stretching, dorsiflexion drills)",
                  "Hip and glute strengthening to address knee valgus",
                  "Left leg balance and stability work",
                  "Right shoulder mobility and rotator cuff strengthening",
                  "Scapular stabilization exercises",
                  "Follow-up assessment in 6-8 weeks to track progress"
                ]
              }
            },
            "meta": {
              "timestamp": "2025-10-23T09:45:00Z",
              "request_id": "req_1729674300_abc123",
              "version": "1.0.0"
            }
          },
          "webhookUrl": "https://fitwithparirp.app.n8n.cloud/webhook-test/ai-agents/create-profiles",
          "executionMode": "test"
        }
      }
    ]
  },
  "versionId": "70d07cc9-8f48-4f07-9b70-95200fbd42a5",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-10-24T09:44:56.467Z",
      "updatedAt": "2025-10-24T09:44:56.467Z",
      "role": "workflow:owner",
      "workflowId": "zgX8K1dD20x9AGc7",
      "projectId": "nnULjHyqOVknXpmc"
    }
  ],
  "tags": []
}