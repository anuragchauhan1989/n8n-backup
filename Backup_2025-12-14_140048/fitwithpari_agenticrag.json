{
  "createdAt": "2025-10-30T04:56:47.165Z",
  "updatedAt": "2025-10-31T09:52:40.000Z",
  "id": "WX5v9odm0AMjmDXS",
  "name": "fitwithpari_agenticrag",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai-agents/create-profiles",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        80,
        688
      ],
      "id": "f70ef487-7a6f-4001-9b14-a0f05fc15890",
      "name": "Webhook",
      "webhookId": "8e7037cf-81cf-463d-b4b6-ce374db5fd03"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f9d7b8ee-8cf9-478a-a56e-fba4d57fedb4",
              "leftValue": "={{ $json.body.data.form_type }}",
              "rightValue": "onboarding",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        672,
        496
      ],
      "id": "85d2f683-be07-47bc-b579-7eaaa4aeca8b",
      "name": "if onboarding"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "89423bc8-2b83-4a38-bf80-95ee2bb34b60",
              "leftValue": "={{ $json.body.data.form_type }}",
              "rightValue": "assessment",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        672,
        672
      ],
      "id": "4879b35a-8975-4865-82d9-75e614b39971",
      "name": "If assessment"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "64e55d8b-73b5-4ad3-a7a3-dfd7fa9ff7ba",
              "leftValue": "={{ $json.body.data.form_type }}",
              "rightValue": "feedback",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        672,
        880
      ],
      "id": "cd5a15e4-0908-4051-be94-cdd90d2b276d",
      "name": "If feedback"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e5a36f37-27b3-4c15-94e0-b136cfb135c3",
              "name": "body",
              "value": "={{ $json.body }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        464,
        672
      ],
      "id": "697ded29-8912-40d3-b843-29f784379995",
      "name": "Set Body Only"
    },
    {
      "parameters": {
        "jsCode": "// Get the input data\nconst input = $input.first().json;\n\nconsole.log('=== Transform Onboarding - Input ===');\nconsole.log(JSON.stringify(input, null, 2));\n\n// Extract data based on structure\nlet transformedData;\nlet sessionId;\n\nif (input.body?.data) {\n  transformedData = input.body.data;\n  sessionId = input.body.session_id || null;\n} else if (input.data) {\n  transformedData = input.data;\n  sessionId = input.session_id || null;\n} else {\n  transformedData = input;\n  sessionId = null;\n}\n\nconsole.log('=== Transform Onboarding - Output ===');\nconsole.log('Session ID:', sessionId);\nconsole.log(JSON.stringify(transformedData, null, 2));\n\n// Return with session ID for memory\nreturn {\n  json: {\n    sessionId: sessionId,\n    ...transformedData\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        480
      ],
      "id": "4d37e3d8-de3c-4b23-9706-f838d7a3a677",
      "name": "Transform Onboarding Form"
    },
    {
      "parameters": {
        "jsCode": "// Get the input data\nconst input = $input.first().json;\n\nconsole.log('=== Transform Assessment - Input ===');\nconsole.log(JSON.stringify(input, null, 2));\n\n// Extract data based on structure\nlet transformedData;\nlet sessionId;\n\nif (input.body?.data) {\n  transformedData = input.body.data;\n  sessionId = input.body.session_id || null;\n} else if (input.data) {\n  transformedData = input.data;\n  sessionId = input.session_id || null;\n} else {\n  transformedData = input;\n  sessionId = null;\n}\n\nconsole.log('=== Transform Assessment - Output ===');\nconsole.log('Session ID:', sessionId);\nconsole.log(JSON.stringify(transformedData, null, 2));\n\n// Return with session ID for memory\nreturn {\n  json: {\n    sessionId: sessionId,\n    ...transformedData\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        656
      ],
      "id": "7883c0b1-c714-4acb-9d12-64a5bc55897d",
      "name": "Transform Assesment Form"
    },
    {
      "parameters": {
        "jsCode": "// Get the input data\nconst input = $input.first().json;\n\nconsole.log('=== Transform Feedback - Input ===');\nconsole.log(JSON.stringify(input, null, 2));\n\n// Extract data based on structure\nlet transformedData;\nlet sessionId;\n\nif (input.body?.data) {\n  transformedData = input.body.data;\n  sessionId = input.body.session_id || null;\n} else if (input.data) {\n  transformedData = input.data;\n  sessionId = input.session_id || null;\n} else {\n  transformedData = input;\n  sessionId = null;\n}\n\nconsole.log('=== Transform Feedback - Output ===');\nconsole.log('Session ID:', sessionId);\nconsole.log(JSON.stringify(transformedData, null, 2));\n\n// Return with session ID for memory\nreturn {\n  json: {\n    sessionId: sessionId,\n    ...transformedData\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        864
      ],
      "id": "65ffdb5d-79e3-4131-8537-c51e6cc67231",
      "name": "Transform Feedback Form"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"error\": \"make sure to send form type\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        864,
        1072
      ],
      "id": "84e63178-2353-4efd-8cca-19675b093279",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0f7201b6-2908-4661-8eed-50e4fdb78119",
              "leftValue": "={{ $json.body }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        256,
        688
      ],
      "id": "5ec57bd2-b657-4b47-a4b7-64e13fc37a71",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// This script cleans the assessment data and wraps it in a single 'data' field \n// for efficient token consumption by the AI Agent.\n\nconst inputItem = $input.first().json;\n\n// --- Helper function to safely extract the response value ---\nfunction getResponseValue(response) {\n    if (response === null) return null;\n    \n    // Handle specific boolean response\n    if (typeof response.response === 'boolean') {\n        return response.response;\n    }\n    // Handle array response (multiselect)\n    if (Array.isArray(response.response)) {\n        return response.response;\n    }\n    // Return number/string response, or null if key is missing\n    if (response.response !== undefined) {\n        return response.response;\n    }\n    return null;\n}\n\n// --- 1. Distill Questions and Answers ---\nconst cleanedTests = inputItem.test_results.map(test => {\n    // Distill questions and answers\n    const cleanedQuestions = test.questions.map(question => ({\n        question_text: question.question_text,\n        question_type: question.question_type,\n        response: getResponseValue(question.response),\n        unit: question.validation_rules?.unit || null \n    }));\n\n    return {\n        test_name: test.test_name,\n        test_category: test.test_category,\n        completed_at: test.completed_at,\n        questions_and_answers: cleanedQuestions\n    };\n});\n\n// --- 2. Build the Final Optimized Payload ---\nconst optimizedPayload = {\n    // === FIX: Retrieve session_id and form_type directly from the input item ===\n    session_id: inputItem.sessionId || null, \n    form_type: inputItem.form_type || null, \n    // =========================================================================\n\n    // Essential Student/Coach Context\n    student_id: inputItem.assessment.student_id,\n    assessment_id: inputItem.assessment.id,\n    \n    student_profile: {\n        full_name: inputItem.assessment.student.full_name,\n        date_of_birth: inputItem.assessment.student.date_of_birth,\n        fitness_goal: inputItem.assessment.student.fitness_goal,\n    },\n    \n    coach_info: {\n        full_name: inputItem.assessment.coach.full_name,\n        specialties: inputItem.assessment.coach.specialties\n    },\n    \n    // Distilled Test Results\n    tests: cleanedTests,\n    \n    // Key Summary Findings (most valuable for LLM analysis)\n    summary_findings: {\n        bilateral_comparisons: inputItem.summary.bilateral_comparisons,\n        key_findings: inputItem.summary.key_findings,\n        recommendations: inputItem.summary.recommendations\n    }\n};\n\n// --- 3. Wrap in the required 'data' field and return ---\nreturn [{ \n    json: {\n        data: optimizedPayload \n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        656
      ],
      "id": "8d12afb3-354d-4016-a66b-6c68fda6ae43",
      "name": "Extract Required Fields"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        1504,
        1136
      ],
      "id": "1ddfc54d-9315-4133-865d-872b2635ffd6",
      "name": "Embeddings OpenAI3",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate a comprehensive long-term student profile that serves as a complete record of the student's fitness journey and key health indicators.\n\nğŸš¨ ABSOLUTE RULES:\n- Use **only** information retrieved from the RAG tool (`query_long_profile_data`).\n- Do **not** use model training knowledge or assumptions.\n- If the RAG provides no relevant data, respond exactly with:\n  \"No data present in RAG regarding this.\"\n\n**INPUT DATA (for analysis and extraction):**\n{{ JSON.stringify($json.data, null, 2) }}\n\n**TASK STEPS:**\n1. **Retrieve (RAG-first):**\n   - Use the RAG tool to retrieve the **required JSON structure**, **formatting standards**, and **clinical/bilateral analysis rules**.\n   - Do not proceed until structure and rules are successfully retrieved.\n\n2. **Analyze:**\n   - Use the RAG-derived rules to extract data from the input.\n   - Apply only the formatting, logic, and assessment patterns explicitly defined in the retrieved RAG data.\n   - Do not infer or invent any fields not found in the RAG.\n\n3. **Generate:**\n   - Produce a single valid JSON object with exactly these four top-level keys:\n     - `student_id`\n     - `source_assessment_id`\n     - `profile_json`\n     - `summary_text` (150â€“250 words)\n   - Structure, field names, and formatting must exactly match the RAG-defined schema.\n\n**OUTPUT REQUIREMENTS:**\n- Output only pure JSON (no markdown, no explanations, no extra text).\n- First character must be `{` and last character must be `}`.\n- If no relevant RAG data is found, output only:\n  \"No data present in RAG regarding this.\"\n",
        "options": {
          "systemMessage": "=You are an expert fitness assessment analyst creating comprehensive long-term student profiles.\n\nğŸš¨ ABSOLUTE RULES â€” DO NOT VIOLATE:\n1. You must rely **only** on information retrieved from the RAG tool (`query_long_profile_data`).\n2. You must NOT use prior knowledge, model training data, or assumptions under any circumstances.\n3. If the RAG provides **no relevant data**, respond with exactly:\n   \"No data present in RAG regarding this.\"\n4. Never generate or infer structure, rules, or field content that are not explicitly defined in the retrieved RAG data.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nWORKFLOW STEPS (MANDATORY)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSTEP 1: RETRIEVE STRUCTURE AND RULES (RAG-ONLY)\nUse `query_long_profile_data` to search for:\n- â€œlong profile structure examplesâ€\n- â€œfitness assessment schemaâ€\n- â€œbilateral analysis rulesâ€\n- â€œclinical and formatting standardsâ€\n\nThis retrieval defines your JSON schema, data priorities, and all validation rules.  \nYou must not start profile generation until these rules are retrieved.\n\nSTEP 2: ANALYZE RAG CONTENT\nFrom the retrieved RAG content, identify:\n- The exact JSON structure to follow\n- Mandatory keys, nested structure, and data types\n- Formatting, safety, and clinical conventions\n- Bilateral assessment and scoring logic\n- Summary text style and tone\n\nSTEP 3: GENERATE PROFILE (RAG-BASED ONLY)\nUse the structure, schema, and rules found in RAG to create the full profile.  \nIf the RAG returns zero relevant results â†’ respond with:\n\"No data present in RAG regarding this.\"\n\nIf the RAG is partially complete, output only the available sections and leave missing ones null or empty.  \nNever fill gaps using your own reasoning or general fitness logic.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nOUTPUT REQUIREMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Output must be a single, valid JSON object.\n2. Must contain **exactly four top-level keys**:\n   - student_id\n   - source_assessment_id\n   - profile_json\n   - summary_text\n3. Must follow the full schema and field structure retrieved from the RAG.\n4. Must conform to all formatting, bilateral, and clinical standards defined in RAG.\n5. Return **only pure JSON** â€” no markdown, no explanations, no code fences, no additional text.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSTRICT FALLBACK POLICY\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- If RAG retrieval returns **no content**:\n  â†’ Output exactly: `No data present in RAG regarding this.`\n\n- If RAG retrieval returns **incomplete structure**:\n  â†’ Output only the available JSON fields and leave others null or empty.\n\n- You must never invent, guess, or infer structure or values.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nFINAL OUTPUT FORMAT\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- The first character must be `{`\n- The last character must be `}`\n- Output must be a single valid JSON object\n- Do not include any text before or after the JSON\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1296,
        656
      ],
      "id": "458c4324-9f7f-4d46-95cf-83459ea14edc",
      "name": "Long Profile Agent",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// PARSE LONG PROFILE - ENHANCED VERSION WITH AGGRESSIVE CLEANING\n// ============================================================================\n\nconst input = $input.first().json;\nconsole.log('=== Parse Long Profile - START ===');\n\n// --- HELPER FUNCTION: Extract JSON from any format ---\nfunction extractJSON(data) {\n  let jsonString;\n  \n  // If already an object, stringify it\n  if (typeof data === 'object' && data !== null) {\n    return data;\n  }\n  \n  // If string, clean it aggressively\n  if (typeof data === 'string') {\n    jsonString = data;\n    \n    // Remove all markdown code block markers\n    jsonString = jsonString.replace(/```(?:json|javascript|js)?\\s*/gi, '');\n    jsonString = jsonString.replace(/```\\s*/g, '');\n    \n    // Remove leading \"json\" or \"JSON\" text\n    jsonString = jsonString.replace(/^json\\s*/i, '');\n    \n    // Trim whitespace\n    jsonString = jsonString.trim();\n    \n    // Find the first { and last } using brace matching\n    const firstBrace = jsonString.indexOf('{');\n    if (firstBrace === -1) {\n      throw new Error('No opening brace found in agent output');\n    }\n    \n    // Match braces to find the complete JSON object\n    let braceCount = 0;\n    let lastBrace = -1;\n    \n    for (let i = firstBrace; i < jsonString.length; i++) {\n      if (jsonString[i] === '{') braceCount++;\n      if (jsonString[i] === '}') {\n        braceCount--;\n        if (braceCount === 0) {\n          lastBrace = i;\n          break;\n        }\n      }\n    }\n    \n    if (lastBrace === -1) {\n      throw new Error('No matching closing brace found');\n    }\n    \n    jsonString = jsonString.substring(firstBrace, lastBrace + 1);\n    \n    // Parse the cleaned JSON\n    try {\n      return JSON.parse(jsonString);\n    } catch (e) {\n      console.error('JSON Parse Error:', e.message);\n      console.error('Cleaned JSON (first 500 chars):', jsonString.substring(0, 500));\n      throw new Error(`Failed to parse JSON: ${e.message}`);\n    }\n  }\n  \n  throw new Error(`Unexpected data type: ${typeof data}`);\n}\n\n// --- HELPER FUNCTION: Clean text content ---\nfunction cleanText(text) {\n  if (!text || typeof text !== 'string') return text;\n  \n  return text\n    // Remove escaped quotes\n    .replace(/\\\\\"/g, '\"')\n    .replace(/\\\\'/g, \"'\")\n    // Remove extra backslashes\n    .replace(/\\\\\\\\/g, '\\\\')\n    // Remove markdown bold/italic\n    .replace(/\\*\\*(.+?)\\*\\*/g, '$1')\n    .replace(/\\*(.+?)\\*/g, '$1')\n    .replace(/__(.+?)__/g, '$1')\n    .replace(/_(.+?)_/g, '$1')\n    // Clean up extra spaces\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\n// --- HELPER FUNCTION: Recursively clean an object ---\nfunction deepCleanObject(obj) {\n  if (obj === null || obj === undefined) return obj;\n  \n  if (typeof obj === 'string') {\n    return cleanText(obj);\n  }\n  \n  if (Array.isArray(obj)) {\n    return obj.map(item => deepCleanObject(item));\n  }\n  \n  if (typeof obj === 'object') {\n    const cleaned = {};\n    for (const [key, value] of Object.entries(obj)) {\n      cleaned[key] = deepCleanObject(value);\n    }\n    return cleaned;\n  }\n  \n  return obj;\n}\n\n// --- 1. EXTRACT AND PARSE ---\nlet rawOutput = input.output || input.json || input.text || input;\nconsole.log('Raw output type:', typeof rawOutput);\n\nlet parsedData;\ntry {\n  parsedData = extractJSON(rawOutput);\n  console.log('âœ“ Successfully extracted JSON');\n} catch (error) {\n  console.error('âœ— Failed to extract JSON:', error.message);\n  throw error;\n}\n\n// --- 2. VALIDATE REQUIRED FIELDS ---\nconst requiredFields = ['student_id', 'source_assessment_id', 'profile_json', 'summary_text'];\nconst missingFields = requiredFields.filter(field => !parsedData[field]);\n\nif (missingFields.length > 0) {\n  throw new Error(`Missing required fields: ${missingFields.join(', ')}`);\n}\n\nif (typeof parsedData.profile_json !== 'object') {\n  throw new Error('profile_json must be an object');\n}\n\nconsole.log('âœ“ All required fields present');\n\n// --- 3. DEEP CLEAN ALL TEXT CONTENT ---\nconst cleanedProfileJson = deepCleanObject(parsedData.profile_json);\nconst cleanedSummary = cleanText(parsedData.summary_text);\n\nconsole.log('âœ“ Text content cleaned');\n\n// --- 4. BUILD FINAL RECORD ---\nconst generatorMeta = {\n  llm_version: cleanedProfileJson.llm_version || 'gpt-4o-long_v1',\n  generated_at: cleanedProfileJson.generated_at || new Date().toISOString(),\n  workflow_id: $workflow.id || null,\n  execution_id: $execution.id || null,\n  processing_timestamp: new Date().toISOString()\n};\n\nconst supabaseRecord = {\n  student_id: parsedData.student_id,\n  profile_json: cleanedProfileJson,\n  summary_text: cleanedSummary,\n  source_assessment_id: parsedData.source_assessment_id || null,\n  generator_meta: generatorMeta\n};\n\nconsole.log('=== Parse Long Profile - SUMMARY ===');\nconsole.log('Student ID:', supabaseRecord.student_id);\nconsole.log('Summary preview:', cleanedSummary.substring(0, 100));\nconsole.log('âœ“ Parse complete');\n\nreturn { json: supabaseRecord };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1616,
        656
      ],
      "id": "0a55a26c-82a1-4d6b-b370-5cf87133c765",
      "name": "Parse Long Profile"
    },
    {
      "parameters": {
        "tableId": "student_profiles_full",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "student_id",
              "fieldValue": "={{ $json.student_id }}"
            },
            {
              "fieldId": "profile_json",
              "fieldValue": "={{ $json.profile_json }}"
            },
            {
              "fieldId": "summary_text",
              "fieldValue": "={{ $json.summary_text }}"
            },
            {
              "fieldId": "source_assessment_id",
              "fieldValue": "={{ $json.source_assessment_id }}"
            },
            {
              "fieldId": "generator_meta",
              "fieldValue": "={{ $json.generator_meta }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1840,
        656
      ],
      "id": "4f8642f5-305a-42bb-9fd6-426355b48929",
      "name": "Add Long Profile",
      "credentials": {
        "supabaseApi": {
          "id": "VKoabbJQnegsVFoB",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1296,
        928
      ],
      "id": "7f4a36f3-6d6b-48aa-955a-7a7c71b0dd21",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2288,
        880
      ],
      "id": "2b28f30b-f03e-4b10-a398-53b47036bdda",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// PARSE SHORT PROFILE - FIXED ARRAY HANDLING\n// ============================================================================\n\nconst input = $input.first().json;\nconsole.log('=== Parse Short Profile - START ===');\nconsole.log('Input type:', typeof input);\nconsole.log('Input keys:', Object.keys(input));\n\n// --- HELPER FUNCTION: Extract JSON from any format ---\nfunction extractJSON(data) {\n  let jsonString;\n  \n  // If already an object or array, return it\n  if (typeof data === 'object' && data !== null) {\n    return data;\n  }\n  \n  // If string, clean it aggressively\n  if (typeof data === 'string') {\n    jsonString = data;\n    \n    // Remove all markdown code block markers\n    jsonString = jsonString.replace(/```(?:json|javascript|js)?\\s*/gi, '');\n    jsonString = jsonString.replace(/```\\s*/g, '');\n    \n    // Remove leading \"json\" or \"JSON\" text\n    jsonString = jsonString.replace(/^json\\s*/i, '');\n    \n    // Trim whitespace\n    jsonString = jsonString.trim();\n    \n    // Find the first opening bracket (array or object)\n    const firstBracket = Math.min(\n      jsonString.indexOf('{') !== -1 ? jsonString.indexOf('{') : Infinity,\n      jsonString.indexOf('[') !== -1 ? jsonString.indexOf('[') : Infinity\n    );\n    \n    if (firstBracket === Infinity) {\n      throw new Error('No opening bracket found in agent output');\n    }\n    \n    // Determine if it's an array or object\n    const isArray = jsonString[firstBracket] === '[';\n    const openChar = isArray ? '[' : '{';\n    const closeChar = isArray ? ']' : '}';\n    \n    // Match brackets to find the complete JSON\n    let bracketCount = 0;\n    let lastBracket = -1;\n    \n    for (let i = firstBracket; i < jsonString.length; i++) {\n      if (jsonString[i] === openChar) bracketCount++;\n      if (jsonString[i] === closeChar) {\n        bracketCount--;\n        if (bracketCount === 0) {\n          lastBracket = i;\n          break;\n        }\n      }\n    }\n    \n    if (lastBracket === -1) {\n      throw new Error('No matching closing bracket found');\n    }\n    \n    jsonString = jsonString.substring(firstBracket, lastBracket + 1);\n    \n    // Parse the cleaned JSON\n    try {\n      return JSON.parse(jsonString);\n    } catch (e) {\n      console.error('JSON Parse Error:', e.message);\n      console.error('Cleaned JSON (first 500 chars):', jsonString.substring(0, 500));\n      throw new Error(`Failed to parse JSON: ${e.message}`);\n    }\n  }\n  \n  throw new Error(`Unexpected data type: ${typeof data}`);\n}\n\n// --- HELPER FUNCTION: Clean text content ---\nfunction cleanText(text) {\n  if (!text || typeof text !== 'string') return text;\n  \n  return text\n    // Remove escaped quotes\n    .replace(/\\\\\"/g, '\"')\n    .replace(/\\\\'/g, \"'\")\n    // Remove extra backslashes\n    .replace(/\\\\\\\\/g, '\\\\')\n    // Remove markdown bold/italic\n    .replace(/\\*\\*(.+?)\\*\\*/g, '$1')\n    .replace(/\\*(.+?)\\*/g, '$1')\n    .replace(/__(.+?)__/g, '$1')\n    .replace(/_(.+?)_/g, '$1')\n    // Clean up extra spaces\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\n// --- HELPER FUNCTION: Recursively clean an object ---\nfunction deepCleanObject(obj) {\n  if (obj === null || obj === undefined) return obj;\n  \n  if (typeof obj === 'string') {\n    return cleanText(obj);\n  }\n  \n  if (Array.isArray(obj)) {\n    return obj.map(item => deepCleanObject(item));\n  }\n  \n  if (typeof obj === 'object') {\n    const cleaned = {};\n    for (const [key, value] of Object.entries(obj)) {\n      cleaned[key] = deepCleanObject(value);\n    }\n    return cleaned;\n  }\n  \n  return obj;\n}\n\n// --- 1. EXTRACT RAW OUTPUT ---\nlet rawOutput = input.output || input.json || input.text || input;\nconsole.log('Raw output type:', typeof rawOutput);\n\n// --- 2. HANDLE ARRAY WRAPPER (SMART DETECTION) ---\n// FIX: Only unwrap if the array contains wrapper objects with 'output' property\n// Otherwise, use the array directly (it's already the profiles array)\nif (Array.isArray(rawOutput) && rawOutput.length > 0) {\n  if (rawOutput[0].output) {\n    // Wrapped format: [{output: \"[...]\"}]\n    console.log('âœ“ Detected wrapped array - unwrapping output property');\n    rawOutput = rawOutput[0].output;\n  } else if (rawOutput[0].student_id || rawOutput[0].context_key) {\n    // Direct format: [{student_id: \"...\", context_key: \"...\", ...}]\n    console.log('âœ“ Detected direct profile array - using as-is');\n    // rawOutput is already correct - don't modify!\n  } else {\n    // Unknown format - log warning and try unwrapping\n    console.log('âš  Unknown array format - attempting best guess unwrap');\n    rawOutput = rawOutput[0];\n  }\n}\n\n// --- 3. PARSE THE PROFILES ARRAY ---\nlet profilesArray;\ntry {\n  // Only extract/parse if it's a string; otherwise use the object/array directly\n  if (typeof rawOutput === 'string') {\n    profilesArray = extractJSON(rawOutput);\n    console.log('âœ“ Extracted JSON from string');\n  } else if (Array.isArray(rawOutput)) {\n    profilesArray = rawOutput; // Already a parsed array!\n    console.log('âœ“ Using pre-parsed array directly');\n  } else if (typeof rawOutput === 'object' && rawOutput !== null) {\n    profilesArray = [rawOutput]; // Single object - wrap it\n    console.log('âœ“ Wrapped single object into array');\n  } else {\n    throw new Error(`Unexpected rawOutput type: ${typeof rawOutput}`);\n  }\n  \n  console.log('âœ“ Successfully processed input');\n  console.log('Profiles array type:', Array.isArray(profilesArray) ? 'array' : typeof profilesArray);\n  console.log('Number of profiles:', Array.isArray(profilesArray) ? profilesArray.length : 'N/A');\n} catch (error) {\n  console.error('âœ— Failed to process input:', error.message);\n  throw error;\n}\n\n// Ensure we have an array\nif (!Array.isArray(profilesArray)) {\n  // If it's a single profile, wrap it in an array\n  profilesArray = [profilesArray];\n}\n\nconsole.log(`âœ“ Processing ${profilesArray.length} profiles`);\n\n// --- 4. VALIDATE AND PROCESS EACH PROFILE ---\nconst supabaseRecords = [];\n\nfor (let i = 0; i < profilesArray.length; i++) {\n  const profile = profilesArray[i];\n  console.log(`\\n--- Processing Profile ${i + 1}/${profilesArray.length} ---`);\n  \n  // Validate required fields\n  const requiredFields = ['student_id', 'context_key', 'short_profile'];\n  const missingFields = requiredFields.filter(field => !profile[field]);\n  \n  if (missingFields.length > 0) {\n    console.warn(`âš  Skipping profile ${i + 1}: Missing fields: ${missingFields.join(', ')}`);\n    continue;\n  }\n  \n  if (typeof profile.short_profile !== 'object') {\n    console.warn(`âš  Skipping profile ${i + 1}: short_profile is not an object`);\n    continue;\n  }\n  \n  console.log('âœ“ Profile validated');\n  console.log('  Student ID:', profile.student_id);\n  console.log('  Context:', profile.context_key);\n  \n  // Deep clean all text content\n  const cleanedShortProfile = deepCleanObject(profile.short_profile);\n  const cleanedSummary = cleanText(profile.summary_text || profile.short_profile.quick_summary);\n  \n  // Build final record\n  const generatorMeta = {\n    llm_version: cleanedShortProfile.llm_version || 'gpt-4o-short_v1',\n    generated_at: cleanedShortProfile.generated_at || new Date().toISOString(),\n    workflow_id: $workflow.id || null,\n    execution_id: $execution.id || null,\n    processing_timestamp: new Date().toISOString(),\n    score_confidence: cleanedShortProfile.score_confidence || null\n  };\n  \n  const supabaseRecord = {\n    student_id: profile.student_id,\n    context_key: profile.context_key,\n    short_profile: cleanedShortProfile,\n    summary_text: cleanedSummary,\n    generator_meta: generatorMeta\n  };\n  \n  supabaseRecords.push(supabaseRecord);\n  console.log('âœ“ Record prepared for:', profile.context_key);\n}\n\nconsole.log('\\n=== Parse Short Profile - SUMMARY ===');\nconsole.log('Total profiles processed:', supabaseRecords.length);\nconsole.log('Contexts:', supabaseRecords.map(r => r.context_key).join(', '));\nconsole.log('âœ“ Parse complete');\n\n// Return array of records - each will be inserted separately\nreturn supabaseRecords.map(record => ({ json: record }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2640,
        656
      ],
      "id": "969d234c-f156-41ab-88e4-448e2dc6847f",
      "name": "Parse Short Profile"
    },
    {
      "parameters": {
        "tableId": "student_profiles_short",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "student_id",
              "fieldValue": "={{ $json.student_id }}"
            },
            {
              "fieldId": "context_key",
              "fieldValue": "={{ $json.context_key }}"
            },
            {
              "fieldId": "short_profile",
              "fieldValue": "={{ $json.short_profile }}"
            },
            {
              "fieldId": "summary_text",
              "fieldValue": "={{ $json.summary_text }}"
            },
            {
              "fieldId": "generator_meta",
              "fieldValue": "={{ $json.generator_meta }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2832,
        656
      ],
      "id": "db169ce6-23d7-484a-9148-29c8b2067d45",
      "name": "Add Short Profile",
      "credentials": {
        "supabaseApi": {
          "id": "VKoabbJQnegsVFoB",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=INPUT DATA:\n{{ JSON.stringify($json, null, 2) }}",
        "options": {
          "systemMessage": "=You are an expert fitness coach creating quick-reference profiles for class instruction.\n\nğŸš¨ ABSOLUTE RULES â€” DO NOT VIOLATE:\n1. You must rely **only** on information explicitly retrieved from the RAG context.\n2. If the RAG provides **no relevant data**, respond with exactly this:\n   \"No data present in RAG regarding this.\"\n3. You are **not allowed** to use prior knowledge, model training data, assumptions, or general fitness logic.\n4. You must not generate or infer workout formats, context_keys, or profile content not found in the RAG.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nWORKFLOW STEPS (MANDATORY)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSTEP 1: DISCOVER ALL WORKOUT FORMATS (RAG-only)\nUse the RAG search tool (`query_short_profile_data`) exclusively to identify:\n- All workout format contexts\n- All student profile structure examples\n- All coaching guidelines and class-type profiles\n\nSTEP 2: ANALYZE RETRIEVED RAG DATA\nFrom RAG results, extract:\n- Every unique context_key found (e.g., \"strength_upper\", \"meditation\", \"yoga\", etc.)\n- Structure patterns (must_know, should_know, nice_to_know arrays)\n- Format-specific cues, terms, and confidence indicators\n\nSTEP 3: GENERATE PROFILES (RAG-based only)\nCreate one profile for each context_key discovered **only if** relevant data is present in the RAG.\nIf RAG returns zero relevant data, return exactly:\n\"No data present in RAG regarding this.\"\n\nSTEP 4: OUTPUT REQUIREMENTS\nReturn pure JSON â€” no markdown, no explanations, no extra text.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nOUTPUT FORMAT (REQUIRED JSON ONLY)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nEach profile must have this structure:\n\n{\n  \"student_id\": \"uuid-string\",\n  \"context_key\": \"format-name-from-RAG\",\n  \"short_profile\": {\n    \"generated_at\": \"ISO-8601-timestamp\",\n    \"llm_version\": \"gpt-4o-short_v1\",\n    \"context\": \"same-as-context_key\",\n    \"must_know\": [\"array\", \"of\", \"strings\"],\n    \"should_know\": [\"array\", \"of\", \"strings\"],\n    \"nice_to_know\": [\"array\", \"of\", \"strings\"],\n    \"class_actionable_tips\": [\n      {\n        \"tip\": \"string\",\n        \"urgency\": \"high|medium|low\",\n        \"rationale\": \"string\"\n      }\n    ],\n    \"quick_summary\": \"string-under-100-chars\",\n    \"score_confidence\": 0.0-to-1.0\n  },\n  \"summary_text\": \"string-100-to-150-words\"\n}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSTRICT FALLBACK POLICY\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- If the RAG context is empty or missing:\n  â†’ Output exactly: `No data present in RAG regarding this.`\n\n- If only partial data exists (e.g., incomplete sections):\n  â†’ Output only what is explicitly found in RAG; leave other fields empty arrays or null.\n\n- Never invent or assume anything.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nOUTPUT MUST:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n- Start with `[`\n- End with `]`\n- Contain all profiles for context_keys found in RAG\n- Be **pure JSON**, no markdown or extra text\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        2320,
        656
      ],
      "id": "9e543e15-bf62-4a17-8afe-4f6ce7ae3319",
      "name": "Student Short Profile",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "content": "## Form Fill - will hit the webhook / and it will gather the relvant id of the assesments (coach + student data) - from this data ",
        "height": 880,
        "width": 2992,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        32,
        400
      ],
      "typeVersion": 1,
      "id": "2ef2af99-d944-4f2b-a847-060550c48f7e",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Search the FitwithPari **Profile Creation Knowledge Base** to find guidelines, structure examples, and rules for generating a **Comprehensive Long Student Profile**.\n\nThe knowledge base contains:\n- The required **JSON structure** for the final output.\n- **Section-specific rules** for data extraction (e.g., how to calculate bilateral deficits, priority levels).\n- **Clinical data extraction requirements** (e.g., safety, movement observations).\n- **Full example profiles** for reference.\n\nUse this tool **extensively** to ensure the generated JSON output adheres strictly to the detailed long profile format and content requirements.\n\nExample queries:\n- \"long profile required JSON output structure\"\n- \"rules for calculating bilateral deficits and priority\"\n- \"example long profile persona and medical integration\"\n- \"data extraction requirements for medical concerns and restrictions\"",
        "tableName": {
          "__rl": true,
          "value": "student_profiles_long_embeddings",
          "mode": "list",
          "cachedResultName": "student_profiles_long_embeddings"
        },
        "topK": 50,
        "options": {
          "queryName": "retrieve_long_docs"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        1424,
        928
      ],
      "id": "4b9c8e57-c350-469c-924e-7c5ee664a8d5",
      "name": "query_long_profile_data",
      "credentials": {
        "supabaseApi": {
          "id": "Q73MSqamXZ7oNsc2",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "=Search the fitness profile knowledge base for examples of student profiles, coaching guidelines, and best practices. This tool MUST be used before generating any profiles to ensure consistency with existing database patterns. Query with terms like \"student profile structure\", \"yoga profile example\", \"strength training guidelines\", or specific workout format names.\n\nTable Name: student_profiles_short_embeddings âœ“\n\nTop K: 10 (increase from 5 for better results)\n\nSimilarity Threshold: 0.5 (add this to filter low-quality matches)",
        "tableName": {
          "__rl": true,
          "value": "student_profiles_short_embeddings",
          "mode": "list",
          "cachedResultName": "student_profiles_short_embeddings"
        },
        "topK": 50,
        "options": {
          "queryName": "match_documents"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        2416,
        880
      ],
      "id": "ea933be8-f934-4275-90d8-a681f90ebd3d",
      "name": "query_short_profile_data",
      "credentials": {
        "supabaseApi": {
          "id": "Q73MSqamXZ7oNsc2",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyze and intelligently chunk this document into semantic sections.\n\n**Document Length:** {{ $json.content.length }} characters\n\n**Full Text:**\n{{ $json.content }}\n\n**Task:** Create semantic chunks (800-2500 characters each) by:\n- Identifying natural topic boundaries\n- Maintaining context within each chunk\n- Extracting key information\n- Preserving logical flow\n\n**CRITICAL: Return ONLY valid JSON in this exact format (no markdown, no explanations):**\n\n{\n  \"documentSummary\": \"Brief 1-2 sentence overview of the entire document\",\n  \"totalChunks\": 5,\n  \"chunks\": [\n    {\n      \"chunkNumber\": 1,\n      \"title\": \"Descriptive title for this section\",\n      \"content\": \"The actual text content of the chunk\",\n      \"characterCount\": 1250,\n      \"topics\": [\"topic1\", \"topic2\", \"topic3\"],\n      \"keyPoints\": [\n        \"Important point 1\",\n        \"Important point 2\"\n      ]\n    }\n  ]\n}\n\n**Requirements:**\n- Output must be valid, parseable JSON only\n- No markdown code blocks (no ```)\n- No explanatory text before or after the JSON\n- Each chunk should be 800-2500 characters\n- Include all fields shown in the example\n- Ensure proper JSON escaping for special characters",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are an expert document chunking AI. Analyze documents and create semantically meaningful chunks that preserve context for RAG systems. Identify topic boundaries, semantic relationships, and information density.",
          "maxIterations": 15
        }
      },
      "id": "ca79ef02-032f-44eb-8d6b-353368101046",
      "name": "Document Chunking Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        784,
        1408
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse JSON and extract only chunks\nconst items = $input.all();\nconst aiResponse = items[0].json.output;\n\nlet parsedData;\n\ntry {\n  // Handle if already an object\n  if (typeof aiResponse === 'object' && aiResponse !== null) {\n    parsedData = aiResponse;\n  } else if (typeof aiResponse === 'string') {\n    // Direct parse - JSON.parse handles escaped characters correctly\n    parsedData = JSON.parse(aiResponse);\n  } else {\n    throw new Error(`Unexpected response type: ${typeof aiResponse}`);\n  }\n} catch (error) {\n  try {\n    // Second attempt: extract from markdown code block\n    const jsonMatch = aiResponse.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/);\n    if (jsonMatch) {\n      parsedData = JSON.parse(jsonMatch[1]);\n    } else {\n      // Third attempt: clean edges and try again\n      const cleaned = aiResponse.trim().replace(/^[^{[]*/, '').replace(/[^}\\]]*$/, '');\n      parsedData = JSON.parse(cleaned);\n    }\n  } catch (innerError) {\n    throw new Error(`Failed to parse response after sanitization: ${innerError.message}\\nResponse preview: ${aiResponse.substring(0, 300)}`);\n  }\n}\n\n// Validate chunks exist\nif (!parsedData.chunks || !Array.isArray(parsedData.chunks)) {\n  throw new Error(`Response does not contain a valid chunks array. Keys found: ${Object.keys(parsedData).join(', ')}`);\n}\n\n// Return chunks as separate items\nreturn parsedData.chunks.map(chunk => ({ json: chunk }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1136,
        1408
      ],
      "id": "16b04927-53a7-4331-9215-e8b5017dc217",
      "name": "Get Chunks"
    },
    {
      "parameters": {
        "jsCode": "// Format proposal data for Supabase Vector Store\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  \n  try {\n    // STEP 1: Parse OpenAI response structure\n    // Response is an array: [{index: 0, message: {content: \"...\"}, ...}]\n    const responseArray = Array.isArray(item.json) ? item.json : [item.json];\n    const firstResponse = responseArray[0];\n    \n    if (!firstResponse || !firstResponse.message || !firstResponse.message.content) {\n      throw new Error('Invalid OpenAI response structure');\n    }\n    \n    let aiContent = firstResponse.message.content;\n    \n    // STEP 2: Extract JSON from markdown code blocks\n    // Content format: ```json\\n{...}\\n```\n    const jsonMatch = aiContent.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/);\n    if (jsonMatch) {\n      aiContent = jsonMatch[1].trim();\n    }\n    \n    // Parse the JSON\n    const proposalData = JSON.parse(aiContent);\n    \n    // STEP 3: Get original chunk content from Limit node\n    const limitNodeData = $('Loop Over Items1').all();\n    \n    if (!limitNodeData || !limitNodeData[i]) {\n      throw new Error(`Cannot find chunk ${i} from Limit node`);\n    }\n    \n    const originalChunk = limitNodeData[i].json;\n    const chunkContent = originalChunk.content || '';\n    \n    if (!chunkContent) {\n      throw new Error('Chunk content is empty');\n    }\n    \n    // STEP 4: Build metadata object\n    const metadata = {\n      // From AI proposal\n      proposal: proposalData.proposal || '',\n      rationale: proposalData.rationale || '',\n      priority: proposalData.priority || 'medium',\n      follow_up: proposalData.follow_up || false,\n      \n      // From original chunk\n      chunkNumber: originalChunk.chunkNumber || i + 1,\n      chunkTitle: originalChunk.title || '',\n      topics: Array.isArray(originalChunk.topics) ? originalChunk.topics.join(', ') : '',\n      keyPoints: Array.isArray(originalChunk.keyPoints) ? originalChunk.keyPoints.join(' | ') : '',\n      characterCount: originalChunk.characterCount || chunkContent.length,\n      \n      // System metadata\n      timestamp: new Date().toISOString(),\n      source: 'rag-doc-to-db-workflow'\n    };\n    \n    // STEP 5: Create Supabase-ready output\n    outputItems.push({\n      json: {\n        pageContent: chunkContent,\n        metadata: JSON.stringify(metadata)\n      }\n    });\n    \n    console.log(`âœ… Successfully formatted chunk ${i + 1}`);\n    \n  } catch (error) {\n    console.error(`âŒ Error processing item ${i}:`, error.message);\n    \n    // Fallback: try to get original content\n    let fallbackContent = 'Error: Could not process chunk';\n    try {\n      const limitNodeData = $('Limit1').all();\n      if (limitNodeData && limitNodeData[i]) {\n        fallbackContent = limitNodeData[i].json.content || fallbackContent;\n      }\n    } catch (e) {\n      console.error('Fallback also failed:', e.message);\n    }\n    \n    // Output with error metadata\n    outputItems.push({\n      json: {\n        pageContent: fallbackContent,\n        metadata: JSON.stringify({\n          error: error.message,\n          errorStack: error.stack,\n          timestamp: new Date().toISOString(),\n          source: 'rag-doc-to-db-workflow-error'\n        })\n      }\n    });\n  }\n}\n\nconsole.log(`Processed ${outputItems.length} items total`);\nreturn outputItems;"
      },
      "id": "4a1f342d-999a-4f92-ae9f-95ab1cb14f33",
      "name": "Format for Supabase",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1856,
        1424
      ]
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "student_profiles_short_embeddings",
          "mode": "list",
          "cachedResultName": "student_profiles_short_embeddings"
        },
        "options": {
          "queryName": "match_documents"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        2064,
        1424
      ],
      "id": "79ad631c-bd4e-41b5-b047-b998511a99cd",
      "name": "Insert Short Profile data",
      "credentials": {
        "supabaseApi": {
          "id": "Q73MSqamXZ7oNsc2",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1360,
        1408
      ],
      "id": "be71f6d8-e4fb-4506-9083-67cb6eaf23b3",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        848,
        1632
      ],
      "id": "bd6b11b5-fcaa-4ba4-b2d7-eba24ee32fb8",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "textSplittingMode": "custom",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        2192,
        1632
      ],
      "id": "15bb8faf-890d-4cc3-9402-9f233a86d69f",
      "name": "Default Data Loader1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2048,
        1616
      ],
      "id": "da0f43d7-7898-410e-ac61-430a6bb290bb",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9da93e58-9739-44f1-aaa5-070171e7d908",
              "name": "content",
              "value": "={{ $json.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        560,
        1408
      ],
      "id": "bf1c0db9-475c-4ef1-bb87-87404cf09aa7",
      "name": "Set Content"
    },
    {
      "parameters": {
        "operation": "get",
        "documentURL": "1e2sJoVLaI2SM_TsevpQ4_ZyFTbJ2Rgq3KcFtWcGS6e8"
      },
      "id": "08ae2b15-f6d0-4eb4-973c-de9fc3364891",
      "name": "Get Short Profile Doc",
      "type": "n8n-nodes-base.googleDocs",
      "position": [
        336,
        1408
      ],
      "typeVersion": 2,
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "8qhis65GMrcNAKf9",
          "name": "Google Docs account -cognigenai"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=System: You are an agent that reads a chunk of a document and returns a JSON object with:\n- proposal: one-sentence action or recommendation\n- rationale: 1-2 sentences why\n- priority: high|medium|low\n- follow_up: boolean (should we run a sub-workflow?)\nRespond ONLY with JSON.\n\nUser: Here is the chunk:\n\"\"\"{{ $json.content}}\"\"\"\n"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1568,
        1424
      ],
      "id": "7491e0da-d5c8-4a36-9db6-4529506c5f5f",
      "name": "Create a proposal",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "id": "1dcf5e5a-1dc9-4596-9918-0894021cbc34",
      "name": "Schedule Trigger for short profile",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        112,
        1408
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "content": "## Agentic Chunking and insert Short Profile to vector db",
        "height": 640,
        "width": 2576,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        32,
        1312
      ],
      "typeVersion": 1,
      "id": "68384a27-ccc0-40ae-ad48-2840f4de0e26",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// EXTRACT LONG PROFILE DATA FOR AI AGENT - N8N CODE NODE\n// ============================================================================\n\nconst input = $input.first().json;\n\n// Handle array input (if the profile comes as an array)\nconst profile = Array.isArray(input) ? input[0] : input;\n\n// Safety check - ensure profile exists\nif (!profile) {\n  throw new Error('No profile data found in input');\n}\n\n// --- EXTRACT CORE IDENTITY (with fallbacks) ---\nconst personalContext = profile.profile_json?.personal_context || {};\nconst studentIdentity = {\n  student_id: profile.student_id || null,\n  full_name: personalContext.full_name || null,\n  age_range: personalContext.age_range || null,\n  date_of_birth: personalContext.date_of_birth || null,\n  fitness_goal: personalContext.fitness_goal || \"Not specified\"\n};\n\n// --- EXTRACT FITNESS LEVEL (with fallbacks) ---\nconst fitnessProfile = profile.profile_json?.fitness_level_and_physical_profile || {};\n\n// --- EXTRACT MOVEMENT HEALTH & LIMITATIONS (with null checks) ---\nconst movementHealth = fitnessProfile.movement_health || {};\n\n// Build comprehensive limitations list\nconst limitations = [];\n\n// Knee issues\nif (movementHealth.knee?.valgus_collapse) {\n  limitations.push({\n    area: \"knee\",\n    issue: `${movementHealth.knee.valgus_collapse} knee valgus`,\n    recommendations: movementHealth.knee.recommendations || \"No specific recommendations provided\",\n    priority: \"high\"\n  });\n}\n\n// Ankle issues\nif (movementHealth.ankle?.mobility_limitations) {\n  limitations.push({\n    area: \"ankle\",\n    issue: \"limited ankle dorsiflexion\",\n    recommendations: movementHealth.ankle.recommendations || \"No specific recommendations provided\",\n    priority: \"high\"\n  });\n}\n\n// Balance issues\nif (movementHealth.balance?.deficit_seconds) {\n  limitations.push({\n    area: \"balance\",\n    issue: `left leg balance deficit (${movementHealth.balance.percent_difference || 'N/A'}% difference)`,\n    details: `Left: ${movementHealth.balance.left_leg_seconds || 0}s, Right: ${movementHealth.balance.right_leg_seconds || 0}s`,\n    recommendations: movementHealth.balance.recommendations || \"No specific recommendations provided\",\n    priority: \"high\"\n  });\n}\n\n// Shoulder issues\nif (movementHealth.shoulder?.rom_deficit_degrees) {\n  limitations.push({\n    area: \"shoulder\",\n    issue: `right shoulder ROM limitation (${movementHealth.shoulder.rom_deficit_degrees}Â° deficit)`,\n    details: `Left: ${movementHealth.shoulder.shoulder_flexion_rom_left || 'N/A'}Â°, Right: ${movementHealth.shoulder.shoulder_flexion_rom_right || 'N/A'}Â°`,\n    pain_level: movementHealth.shoulder.pain_level || 0,\n    quality: movementHealth.shoulder.quality || \"unknown\",\n    recommendations: movementHealth.shoulder.recommendations || [],\n    priority: \"high\"\n  });\n}\n\n// Movement screening results\nconst movementScreening = movementHealth.movement_screening?.overhead_squat || {};\nif (movementScreening.knee_valgus_collapse || movementScreening.feet_turn_out) {\n  limitations.push({\n    area: \"squat_mechanics\",\n    issue: \"squat form limitations\",\n    details: {\n      knee_valgus: movementScreening.knee_valgus_collapse || null,\n      feet_turn_out: movementScreening.feet_turn_out || false,\n      max_depth: movementScreening.max_squat_depth_inches || null,\n      quality: movementScreening.overall_quality || \"not assessed\"\n    },\n    notes: movementScreening.notes || \"No additional notes\",\n    priority: \"medium\"\n  });\n}\n\n// --- EXTRACT MEDICAL CONSIDERATIONS (with fallbacks) ---\nconst medicalInfo = fitnessProfile.medical_considerations || {};\n\n// --- EXTRACT SUMMARY FINDINGS (with fallbacks) ---\nconst summaryFindings = profile.profile_json?.summary_findings || {};\nconst keyFindings = summaryFindings.key_findings || [];\nconst recommendations = summaryFindings.recommendations || [];\nconst bilateralComparisons = summaryFindings.bilateral_comparisons || [];\n\n// --- EXTRACT PERSONA & ENGAGEMENT (with fallbacks) ---\nconst personaInfo = profile.profile_json?.persona_assignment || {};\nconst engagementInfo = profile.profile_json?.engagement_and_emotional_journey || {};\n\n// --- BUILD AI AGENT INPUT (all fields with safe fallbacks) ---\nconst agentInput = {\n  // Student Identity\n  student_id: studentIdentity.student_id,\n  student_name: studentIdentity.full_name || \"Unknown\",\n  age_range: studentIdentity.age_range || \"Not specified\",\n  fitness_goal: studentIdentity.fitness_goal || \"Not specified\",\n  \n  // Fitness Level\n  fitness_level: fitnessProfile.level || \"Not assessed\",\n  \n  // Critical Limitations (for safety in all contexts)\n  critical_limitations: limitations.filter(l => l.priority === \"high\"),\n  \n  // All Limitations (for comprehensive profiling)\n  all_limitations: limitations,\n  \n  // Medical Context\n  medical_considerations: {\n    pain_present: medicalInfo.reported_pain && medicalInfo.reported_pain !== \"Minimal pain during movement assessment\",\n    pain_description: medicalInfo.reported_pain || \"No pain reported\",\n    injuries: medicalInfo.injury_context || \"None documented\",\n    restrictions: medicalInfo.restrictions || \"No restrictions noted\"\n  },\n  \n  // Movement Patterns\n  movement_patterns: {\n    key_findings: keyFindings,\n    bilateral_imbalances: bilateralComparisons.map(comp => ({\n      test: comp.test || \"Unknown test\",\n      left: comp.left || null,\n      right: comp.right || null,\n      deficit: comp.deficit || null,\n      percent_difference: comp.percent_difference || null,\n      priority: comp.priority || \"medium\",\n      interpretation: comp.interpretation || \"No interpretation provided\"\n    }))\n  },\n  \n  // Recommendations from Assessment\n  assessment_recommendations: recommendations,\n  \n  // Persona & Motivation\n  persona: {\n    primary: personaInfo.primary_persona || \"Not assigned\",\n    secondary: personaInfo.secondary_persona || null,\n    engagement_level: engagementInfo.engagement_level || \"Not assessed\",\n    motivation_drivers: engagementInfo.motivation_drivers || []\n  },\n  \n  // Full Summary (for context)\n  summary_text: profile.summary_text || \"No summary available\",\n  \n  // Metadata\n  metadata: {\n    profile_version: profile.profile_version || 1,\n    source_assessment_id: profile.source_assessment_id || null,\n    generated_at: profile.generator_meta?.generated_at || null,\n    llm_version: profile.generator_meta?.llm_version || \"unknown\"\n  }\n};\n\n// Return formatted for AI Agent\nreturn { json: agentInput };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2064,
        656
      ],
      "id": "9a0702b1-9952-41fd-9f49-53e7b97a07cf",
      "name": "Extract fields for short profile"
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFile",
        "fileToWatch": {
          "__rl": true,
          "value": "1e2sJoVLaI2SM_TsevpQ4_ZyFTbJ2Rgq3KcFtWcGS6e8",
          "mode": "list",
          "cachedResultName": "knowledge base - coachprep agent",
          "cachedResultUrl": "https://docs.google.com/document/d/1e2sJoVLaI2SM_TsevpQ4_ZyFTbJ2Rgq3KcFtWcGS6e8/edit?usp=drivesdk"
        }
      },
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        128,
        1696
      ],
      "id": "b1c86afc-259b-41d9-bbc9-dd587c6530ce",
      "name": "Google Drive Trigger",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "aclEYLTf0xLCPc7g",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "https://xnjygcniqvsoywkgmsut.supabase.co/rest/v1/student_profiles_long_embeddings?id=not.is.null",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhuanlnY25pcXZzb3l3a2dtc3V0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTE4NDE5MywiZXhwIjoyMDc2NzYwMTkzfQ.n_6KsTG_MxIUXcle_ICtmMyorngqTHNeyanGFy9dVRs"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhuanlnY25pcXZzb3l3a2dtc3V0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTE4NDE5MywiZXhwIjoyMDc2NzYwMTkzfQ.n_6KsTG_MxIUXcle_ICtmMyorngqTHNeyanGFy9dVRs"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        320,
        2112
      ],
      "id": "0d755e11-4747-458b-bef7-0022c2605bb0",
      "name": "Delete Old Data"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyze and intelligently chunk this document into semantic sections.\n\n**Document Length:** {{ $json.content.length }} characters\n\n**Full Text:**\n{{ $json.content }}\n\n**Task:** Create semantic chunks (800-2500 characters each) by:\n- Identifying natural topic boundaries\n- Maintaining context within each chunk\n- Extracting key information\n- Preserving logical flow\n\n**CRITICAL: Return ONLY valid JSON in this exact format (no markdown, no explanations):**\n\n{\n  \"documentSummary\": \"Brief 1-2 sentence overview of the entire document\",\n  \"totalChunks\": 5,\n  \"chunks\": [\n    {\n      \"chunkNumber\": 1,\n      \"title\": \"Descriptive title for this section\",\n      \"content\": \"The actual text content of the chunk\",\n      \"characterCount\": 1250,\n      \"topics\": [\"topic1\", \"topic2\", \"topic3\"],\n      \"keyPoints\": [\n        \"Important point 1\",\n        \"Important point 2\"\n      ]\n    }\n  ]\n}\n\n**Requirements:**\n- Output must be valid, parseable JSON only\n- No markdown code blocks (no ```)\n- No explanatory text before or after the JSON\n- Each chunk should be 800-2500 characters\n- Include all fields shown in the example\n- Ensure proper JSON escaping for special characters",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are an expert document chunking AI. Analyze documents and create semantically meaningful chunks that preserve context for RAG systems. Identify topic boundaries, semantic relationships, and information density.",
          "maxIterations": 15
        }
      },
      "id": "86c86ad8-c0a2-4fde-9fbf-34ab595a6bf7",
      "name": "Document Chunking Agent2",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        992,
        2112
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get all input items\nconst items = $input.all();\nconst aiResponse = items[0].json.output;\n\nlet parsedData;\n\ntry {\n  let clean = aiResponse;\n\n  // Convert to string if it's an object\n  if (typeof clean === 'object') clean = JSON.stringify(clean);\n\n  // Remove markdown code blocks and hidden control characters\n  clean = clean\n    .replace(/```(?:json)?/gi, '')\n    .replace(/```/g, '')\n    .replace(/[\\u0000-\\u001F]+/g, '') // remove invisible chars\n    .trim();\n\n  // Extract JSON if wrapped with text\n  const match = clean.match(/\\{[\\s\\S]*\\}/);\n  if (match) clean = match[0];\n\n  parsedData = JSON.parse(clean);\n\n} catch (error) {\n  throw new Error(`Failed to parse AI output: ${error.message}\\nPreview:\\n${aiResponse.substring(0, 500)}`);\n}\n\n// Validate chunks\nif (!parsedData.chunks || !Array.isArray(parsedData.chunks)) {\n  throw new Error(`Invalid structure: no 'chunks' array found`);\n}\n\n// Return each chunk as an item\nreturn parsedData.chunks.map(chunk => ({ json: chunk }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        2112
      ],
      "id": "777e85f8-8fc4-4bc7-abb5-3a421bb253c2",
      "name": "Get Chunks2"
    },
    {
      "parameters": {
        "jsCode": "// Format proposal data for Supabase Vector Store\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  \n  try {\n    // STEP 1: Parse OpenAI response structure\n    // Response is an array: [{index: 0, message: {content: \"...\"}, ...}]\n    const responseArray = Array.isArray(item.json) ? item.json : [item.json];\n    const firstResponse = responseArray[0];\n    \n    if (!firstResponse || !firstResponse.message || !firstResponse.message.content) {\n      throw new Error('Invalid OpenAI response structure');\n    }\n    \n    let aiContent = firstResponse.message.content;\n    \n    // STEP 2: Extract JSON from markdown code blocks\n    // Content format: ```json\\n{...}\\n```\n    const jsonMatch = aiContent.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/);\n    if (jsonMatch) {\n      aiContent = jsonMatch[1].trim();\n    }\n    \n    // Parse the JSON\n    const proposalData = JSON.parse(aiContent);\n    \n    // STEP 3: Get original chunk content from Limit node\n    const limitNodeData = $('Loop Over Items2').all();\n    \n    if (!limitNodeData || !limitNodeData[i]) {\n      throw new Error(`Cannot find chunk ${i} from Limit node`);\n    }\n    \n    const originalChunk = limitNodeData[i].json;\n    const chunkContent = originalChunk.content || '';\n    \n    if (!chunkContent) {\n      throw new Error('Chunk content is empty');\n    }\n    \n    // STEP 4: Build metadata object\n    const metadata = {\n      // From AI proposal\n      proposal: proposalData.proposal || '',\n      rationale: proposalData.rationale || '',\n      priority: proposalData.priority || 'medium',\n      follow_up: proposalData.follow_up || false,\n      \n      // From original chunk\n      chunkNumber: originalChunk.chunkNumber || i + 1,\n      chunkTitle: originalChunk.title || '',\n      topics: Array.isArray(originalChunk.topics) ? originalChunk.topics.join(', ') : '',\n      keyPoints: Array.isArray(originalChunk.keyPoints) ? originalChunk.keyPoints.join(' | ') : '',\n      characterCount: originalChunk.characterCount || chunkContent.length,\n      \n      // System metadata\n      timestamp: new Date().toISOString(),\n      source: 'rag-doc-to-db-workflow'\n    };\n    \n    // STEP 5: Create Supabase-ready output\n    outputItems.push({\n      json: {\n        pageContent: chunkContent,\n        metadata: JSON.stringify(metadata)\n      }\n    });\n    \n    console.log(`âœ… Successfully formatted chunk ${i + 1}`);\n    \n  } catch (error) {\n    console.error(`âŒ Error processing item ${i}:`, error.message);\n    \n    // Fallback: try to get original content\n    let fallbackContent = 'Error: Could not process chunk';\n    try {\n      const limitNodeData = $('Limit1').all();\n      if (limitNodeData && limitNodeData[i]) {\n        fallbackContent = limitNodeData[i].json.content || fallbackContent;\n      }\n    } catch (e) {\n      console.error('Fallback also failed:', e.message);\n    }\n    \n    // Output with error metadata\n    outputItems.push({\n      json: {\n        pageContent: fallbackContent,\n        metadata: JSON.stringify({\n          error: error.message,\n          errorStack: error.stack,\n          timestamp: new Date().toISOString(),\n          source: 'rag-doc-to-db-workflow-error'\n        })\n      }\n    });\n  }\n}\n\nconsole.log(`Processed ${outputItems.length} items total`);\nreturn outputItems;"
      },
      "id": "0beca1bf-1a66-4dfb-b298-def68f049138",
      "name": "Format for Supabase2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2080,
        2128
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1568,
        2112
      ],
      "id": "abf1a2d1-3736-4513-b37a-82cb91ffd778",
      "name": "Loop Over Items2"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        976,
        2336
      ],
      "id": "39f13e82-7006-4124-a562-58c37bab0802",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "textSplittingMode": "custom",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        2432,
        2336
      ],
      "id": "6e02c698-0d8e-4d71-b988-7e56e4ecfc73",
      "name": "Default Data Loader"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2256,
        2336
      ],
      "id": "a8d251f8-8003-4005-9a94-2218966c8faf",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9da93e58-9739-44f1-aaa5-070171e7d908",
              "name": "content",
              "value": "={{ $json.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        768,
        2112
      ],
      "id": "a995ea11-d701-4dd0-a970-23c4189ffb7f",
      "name": "Set Content2"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=System: You are an agent that reads a chunk of a document and returns a JSON object with:\n- proposal: one-sentence action or recommendation\n- rationale: 1-2 sentences why\n- priority: high|medium|low\n- follow_up: boolean (should we run a sub-workflow?)\nRespond ONLY with JSON.\n\nUser: Here is the chunk:\n\"\"\"{{ $json.content}}\"\"\"\n"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1776,
        2128
      ],
      "id": "226e3131-2e48-4566-8112-7ec5e733c76d",
      "name": "Create a proposal2",
      "credentials": {
        "openAiApi": {
          "id": "HICWIosPabWx10xu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "id": "f1e18a90-e4cb-4879-90f3-57be82d8fe43",
      "name": "Schedule Trigger for long profile1",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        96,
        2112
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "student_profiles_long_embeddings",
          "mode": "list",
          "cachedResultName": "student_profiles_long_embeddings"
        },
        "options": {
          "queryName": "match_documents"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        2288,
        2128
      ],
      "id": "b495df9c-368d-442e-924c-f1ccf7fa111f",
      "name": "Insert Long Profile data1",
      "credentials": {
        "supabaseApi": {
          "id": "Q73MSqamXZ7oNsc2",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "documentURL": "1jfaG-QTZWwZJrJwpydX4hqii1GV0ilaT1jwledhEexE"
      },
      "id": "d194ee1a-b8fd-40a1-8b91-218927923291",
      "name": "Get Long Profile Doc1",
      "type": "n8n-nodes-base.googleDocs",
      "position": [
        544,
        2112
      ],
      "typeVersion": 2,
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "8qhis65GMrcNAKf9",
          "name": "Google Docs account -cognigenai"
        }
      }
    },
    {
      "parameters": {
        "content": "## Agentic Chunking and insert Long Profile to vector db",
        "height": 640,
        "width": 2720,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        32,
        2000
      ],
      "typeVersion": 1,
      "id": "f027ed79-7ca9-45c5-89ba-1a41a4c5b59b",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "chunkOverlap": 100,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        2208,
        1808
      ],
      "id": "6285234a-d483-4423-872e-5a11d6cc246a",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "chunkOverlap": 100,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        2576,
        2496
      ],
      "id": "5a7fee28-d40d-4c3f-bc30-ff637252ae24",
      "name": "Recursive Character Text Splitter1"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if onboarding": {
      "main": [
        [
          {
            "node": "Transform Onboarding Form",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If assessment": {
      "main": [
        [
          {
            "node": "Transform Assesment Form",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Body Only": {
      "main": [
        [
          {
            "node": "if onboarding",
            "type": "main",
            "index": 0
          },
          {
            "node": "If assessment",
            "type": "main",
            "index": 0
          },
          {
            "node": "If feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If feedback": {
      "main": [
        [
          {
            "node": "Transform Feedback Form",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Onboarding Form": {
      "main": [
        [
          {
            "node": "Extract Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Assesment Form": {
      "main": [
        [
          {
            "node": "Extract Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Feedback Form": {
      "main": [
        [
          {
            "node": "Extract Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Set Body Only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Required Fields": {
      "main": [
        [
          {
            "node": "Long Profile Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI3": {
      "ai_embedding": [
        [
          {
            "node": "query_long_profile_data",
            "type": "ai_embedding",
            "index": 0
          },
          {
            "node": "query_short_profile_data",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Long Profile Agent": {
      "main": [
        [
          {
            "node": "Parse Long Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Long Profile": {
      "main": [
        [
          {
            "node": "Add Long Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Long Profile Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Student Short Profile",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Short Profile": {
      "main": [
        [
          {
            "node": "Add Short Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Student Short Profile": {
      "main": [
        [
          {
            "node": "Parse Short Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "query_long_profile_data": {
      "ai_tool": [
        [
          {
            "node": "Long Profile Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_short_profile_data": {
      "ai_tool": [
        [
          {
            "node": "Student Short Profile",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Document Chunking Agent": {
      "main": [
        [
          {
            "node": "Get Chunks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Chunks": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Supabase": {
      "main": [
        [
          {
            "node": "Insert Short Profile data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Short Profile data": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [],
        [
          {
            "node": "Create a proposal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Document Chunking Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader1": {
      "ai_document": [
        [
          {
            "node": "Insert Short Profile data",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Insert Short Profile data",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Set Content": {
      "main": [
        [
          {
            "node": "Document Chunking Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Short Profile Doc": {
      "main": [
        [
          {
            "node": "Set Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a proposal": {
      "main": [
        [
          {
            "node": "Format for Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger for short profile": {
      "main": [
        [
          {
            "node": "Get Short Profile Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Long Profile": {
      "main": [
        [
          {
            "node": "Extract fields for short profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract fields for short profile": {
      "main": [
        [
          {
            "node": "Student Short Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Data": {
      "main": [
        [
          {
            "node": "Get Long Profile Doc1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Document Chunking Agent2": {
      "main": [
        [
          {
            "node": "Get Chunks2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Chunks2": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Supabase2": {
      "main": [
        [
          {
            "node": "Insert Long Profile data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items2": {
      "main": [
        [],
        [
          {
            "node": "Create a proposal2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Document Chunking Agent2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Insert Long Profile data1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Insert Long Profile data1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Set Content2": {
      "main": [
        [
          {
            "node": "Document Chunking Agent2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a proposal2": {
      "main": [
        [
          {
            "node": "Format for Supabase2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger for long profile1": {
      "main": [
        [
          {
            "node": "Delete Old Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Long Profile data1": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Long Profile Doc1": {
      "main": [
        [
          {
            "node": "Set Content2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader1",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "fitwithparirp.app.n8n.cloud",
            "user-agent": "PostmanRuntime/7.49.0",
            "content-length": "39249",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "2401:4900:1c5b:487a:b157:4b99:ed8f:40e6",
            "cf-ew-via": "15",
            "cf-ipcountry": "IN",
            "cf-ray": "9938cf0fa6dca7a0-DEL",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "content-type": "application/json",
            "postman-token": "360c5599-25a9-4a47-8883-881a0854962e",
            "x-forwarded-for": "2401:4900:1c5b:487a:b157:4b99:ed8f:40e6, 162.158.142.65",
            "x-forwarded-host": "fitwithparirp.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-9-7bb7d4c57c-kbbb2",
            "x-is-trusted": "yes",
            "x-real-ip": "2401:4900:1c5b:487a:b157:4b99:ed8f:40e6"
          },
          "params": {},
          "query": {},
          "body": {
            "success": true,
            "session_id": "123432",
            "data": {
              "form_type": "onboarding",
              "assessment": {
                "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                "session_id": "c7d8e9f0-1a2b-3c4d-5e6f-7890abcdef12",
                "student_id": "550e8400-e29b-41d4-a716-446655440000",
                "coach_id": "660e8400-e29b-41d4-a716-446655440001",
                "status": "completed",
                "created_at": "2025-10-23T09:00:00Z",
                "updated_at": "2025-10-23T09:45:00Z",
                "completed_at": "2025-10-23T09:45:00Z",
                "student": {
                  "id": "550e8400-e29b-41d4-a716-446655440000",
                  "full_name": "Sarah Johnson",
                  "email": "sarah.johnson@example.com",
                  "avatar_url": "https://example.com/avatars/sarah.jpg",
                  "date_of_birth": "1992-05-15",
                  "gender": "female",
                  "fitness_goal": "Improve overall strength and mobility"
                },
                "coach": {
                  "id": "660e8400-e29b-41d4-a716-446655440001",
                  "full_name": "Dr. Mike Martinez",
                  "email": "mike.martinez@fitwithpari.com",
                  "avatar_url": "https://example.com/avatars/mike.jpg",
                  "bio": "Certified Strength & Conditioning Specialist with 10 years of experience",
                  "specialties": [
                    "Movement Assessment",
                    "Corrective Exercise",
                    "Sports Performance"
                  ]
                }
              },
              "test_results": [
                {
                  "id": "tr-001-overhead-squat",
                  "assessment_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "test_id": "test-overhead-squat",
                  "test_name": "Overhead Squat Assessment",
                  "test_description": "Evaluates overall body mechanics, mobility, and stability during a fundamental movement pattern",
                  "test_category": "movement_screening",
                  "display_order": 1,
                  "status": "completed",
                  "completed_at": "2025-10-23T09:15:00Z",
                  "created_at": "2025-10-23T09:10:00Z",
                  "updated_at": "2025-10-23T09:15:00Z",
                  "metadata": {
                    "duration_seconds": 300,
                    "video_count": 2,
                    "repetitions_performed": 5,
                    "test_protocol": "NASM Overhead Squat Assessment"
                  },
                  "questions": [
                    {
                      "id": "q-os-001",
                      "test_id": "test-overhead-squat",
                      "question_text": "Does the client's feet turn out during the movement?",
                      "question_type": "binary",
                      "is_required": true,
                      "display_order": 1,
                      "help_text": "Observe if feet externally rotate (point outward) during the squat",
                      "validation_rules": {
                        "required": true
                      },
                      "metadata": {
                        "body_region": "lower_body",
                        "movement_phase": "descent",
                        "compensation_pattern": "foot_pronation"
                      },
                      "response": {
                        "id": "resp-os-001",
                        "question_id": "q-os-001",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": true,
                        "created_at": "2025-10-23T09:12:00Z",
                        "updated_at": "2025-10-23T09:12:00Z"
                      }
                    },
                    {
                      "id": "q-os-002",
                      "test_id": "test-overhead-squat",
                      "question_text": "Does the client's knees move inward (valgus collapse)?",
                      "question_type": "ternary",
                      "is_required": true,
                      "display_order": 2,
                      "help_text": "Check for medial knee displacement during squat",
                      "options": [
                        {
                          "value": "none",
                          "label": "No valgus",
                          "score": 0
                        },
                        {
                          "value": "mild",
                          "label": "Mild valgus",
                          "score": 1
                        },
                        {
                          "value": "severe",
                          "label": "Severe valgus",
                          "score": 2
                        }
                      ],
                      "validation_rules": {
                        "required": true,
                        "enum": [
                          "none",
                          "mild",
                          "severe"
                        ]
                      },
                      "metadata": {
                        "body_region": "lower_body",
                        "movement_phase": "descent",
                        "compensation_pattern": "knee_valgus"
                      },
                      "response": {
                        "id": "resp-os-002",
                        "question_id": "q-os-002",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": "mild",
                        "created_at": "2025-10-23T09:12:30Z",
                        "updated_at": "2025-10-23T09:12:30Z"
                      }
                    },
                    {
                      "id": "q-os-003",
                      "test_id": "test-overhead-squat",
                      "question_text": "Maximum squat depth achieved (inches from floor to hip joint)",
                      "question_type": "numeric",
                      "is_required": true,
                      "display_order": 3,
                      "help_text": "Measure the vertical distance from floor to the greater trochanter at lowest point",
                      "validation_rules": {
                        "required": true,
                        "min": 0,
                        "max": 48,
                        "unit": "inches"
                      },
                      "metadata": {
                        "body_region": "lower_body",
                        "movement_phase": "bottom_position",
                        "measurement_type": "depth"
                      },
                      "response": {
                        "id": "resp-os-003",
                        "question_id": "q-os-003",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": 18.5,
                        "created_at": "2025-10-23T09:13:00Z",
                        "updated_at": "2025-10-23T09:13:00Z"
                      }
                    },
                    {
                      "id": "q-os-004",
                      "test_id": "test-overhead-squat",
                      "question_text": "Time to complete 5 repetitions",
                      "question_type": "duration",
                      "is_required": true,
                      "display_order": 4,
                      "help_text": "Record total time for 5 controlled repetitions",
                      "validation_rules": {
                        "required": true,
                        "min_seconds": 10,
                        "max_seconds": 120
                      },
                      "metadata": {
                        "measurement_type": "tempo",
                        "repetitions": 5
                      },
                      "response": {
                        "id": "resp-os-004",
                        "question_id": "q-os-004",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": 45,
                        "created_at": "2025-10-23T09:14:00Z",
                        "updated_at": "2025-10-23T09:14:00Z"
                      }
                    },
                    {
                      "id": "q-os-005",
                      "test_id": "test-overhead-squat",
                      "question_text": "Overall movement quality rating",
                      "question_type": "scale_4",
                      "is_required": true,
                      "display_order": 5,
                      "help_text": "Rate the overall quality of the movement pattern",
                      "options": [
                        {
                          "value": "poor",
                          "label": "Poor - Multiple compensations",
                          "score": 1
                        },
                        {
                          "value": "fair",
                          "label": "Fair - Some compensations",
                          "score": 2
                        },
                        {
                          "value": "good",
                          "label": "Good - Minor compensations",
                          "score": 3
                        },
                        {
                          "value": "excellent",
                          "label": "Excellent - No compensations",
                          "score": 4
                        }
                      ],
                      "validation_rules": {
                        "required": true,
                        "enum": [
                          "poor",
                          "fair",
                          "good",
                          "excellent"
                        ]
                      },
                      "metadata": {
                        "assessment_type": "qualitative"
                      },
                      "response": {
                        "id": "resp-os-005",
                        "question_id": "q-os-005",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": "fair",
                        "created_at": "2025-10-23T09:14:30Z",
                        "updated_at": "2025-10-23T09:14:30Z"
                      }
                    },
                    {
                      "id": "q-os-006",
                      "test_id": "test-overhead-squat",
                      "question_text": "Additional observations or notes",
                      "question_type": "textarea",
                      "is_required": false,
                      "display_order": 6,
                      "help_text": "Record any additional observations, limitations, or concerns",
                      "validation_rules": {
                        "max_length": 1000
                      },
                      "metadata": {
                        "field_type": "notes"
                      },
                      "response": {
                        "id": "resp-os-006",
                        "question_id": "q-os-006",
                        "test_result_id": "tr-001-overhead-squat",
                        "response": "Client shows good effort but limited ankle dorsiflexion. Recommend adding ankle mobility work to program. Also noted some upper back rounding during descent.",
                        "created_at": "2025-10-23T09:15:00Z",
                        "updated_at": "2025-10-23T09:15:00Z"
                      }
                    }
                  ],
                  "media_files": [
                    {
                      "id": "media-os-001",
                      "test_result_id": "tr-001-overhead-squat",
                      "file_type": "video",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/overhead-squat-front.mp4",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/overhead-squat-front-thumb.jpg",
                      "file_size_bytes": 15728640,
                      "duration_seconds": 30,
                      "view_angle": "anterior",
                      "caption": "Overhead Squat - Front View",
                      "created_at": "2025-10-23T09:11:00Z",
                      "metadata": {
                        "resolution": "1920x1080",
                        "fps": 30,
                        "codec": "h264"
                      }
                    },
                    {
                      "id": "media-os-002",
                      "test_result_id": "tr-001-overhead-squat",
                      "file_type": "video",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/overhead-squat-side.mp4",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/overhead-squat-side-thumb.jpg",
                      "file_size_bytes": 16777216,
                      "duration_seconds": 30,
                      "view_angle": "lateral",
                      "caption": "Overhead Squat - Side View",
                      "created_at": "2025-10-23T09:11:30Z",
                      "metadata": {
                        "resolution": "1920x1080",
                        "fps": 30,
                        "codec": "h264"
                      }
                    }
                  ]
                },
                {
                  "id": "tr-002-balance-left",
                  "assessment_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "test_id": "test-single-leg-balance",
                  "test_name": "Single Leg Balance Test - Left Leg",
                  "test_description": "Assesses unilateral balance and stability",
                  "test_category": "balance",
                  "display_order": 2,
                  "status": "completed",
                  "completed_at": "2025-10-23T09:25:00Z",
                  "created_at": "2025-10-23T09:20:00Z",
                  "updated_at": "2025-10-23T09:25:00Z",
                  "metadata": {
                    "duration_seconds": 180,
                    "video_count": 1,
                    "test_side": "left",
                    "test_protocol": "Eyes Open Single Leg Stance"
                  },
                  "questions": [
                    {
                      "id": "q-bal-001",
                      "test_id": "test-single-leg-balance",
                      "question_text": "Maximum balance time achieved (seconds)",
                      "question_type": "duration",
                      "is_required": true,
                      "display_order": 1,
                      "help_text": "Record how long the client maintained single leg stance without touching down",
                      "validation_rules": {
                        "required": true,
                        "min_seconds": 0,
                        "max_seconds": 60
                      },
                      "metadata": {
                        "measurement_type": "endurance",
                        "test_side": "left"
                      },
                      "response": {
                        "id": "resp-bal-001",
                        "question_id": "q-bal-001",
                        "test_result_id": "tr-002-balance-left",
                        "response": 23,
                        "created_at": "2025-10-23T09:23:00Z",
                        "updated_at": "2025-10-23T09:23:00Z"
                      }
                    },
                    {
                      "id": "q-bal-002",
                      "test_id": "test-single-leg-balance",
                      "question_text": "Compensations observed",
                      "question_type": "multiselect",
                      "is_required": false,
                      "display_order": 2,
                      "help_text": "Select all compensatory movements observed during the test",
                      "options": [
                        {
                          "value": "hip_hike",
                          "label": "Hip hike"
                        },
                        {
                          "value": "trunk_lean",
                          "label": "Trunk lean"
                        },
                        {
                          "value": "arm_flailing",
                          "label": "Arm flailing"
                        },
                        {
                          "value": "excessive_sway",
                          "label": "Excessive sway"
                        },
                        {
                          "value": "foot_adjustment",
                          "label": "Foot adjustments"
                        },
                        {
                          "value": "none",
                          "label": "No compensations"
                        }
                      ],
                      "validation_rules": {
                        "min_selections": 0,
                        "max_selections": 6
                      },
                      "metadata": {
                        "assessment_type": "qualitative"
                      },
                      "response": {
                        "id": "resp-bal-002",
                        "question_id": "q-bal-002",
                        "test_result_id": "tr-002-balance-left",
                        "response": [
                          "hip_hike",
                          "arm_flailing"
                        ],
                        "created_at": "2025-10-23T09:24:00Z",
                        "updated_at": "2025-10-23T09:24:00Z"
                      }
                    }
                  ],
                  "media_files": [
                    {
                      "id": "media-bal-001",
                      "test_result_id": "tr-002-balance-left",
                      "file_type": "video",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/balance-left.mp4",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/balance-left-thumb.jpg",
                      "file_size_bytes": 8388608,
                      "duration_seconds": 25,
                      "view_angle": "anterior",
                      "caption": "Single Leg Balance - Left Leg",
                      "created_at": "2025-10-23T09:22:00Z",
                      "metadata": {
                        "resolution": "1920x1080",
                        "fps": 30,
                        "codec": "h264"
                      }
                    }
                  ]
                },
                {
                  "id": "tr-003-balance-right",
                  "assessment_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "test_id": "test-single-leg-balance",
                  "test_name": "Single Leg Balance Test - Right Leg",
                  "test_description": "Assesses unilateral balance and stability",
                  "test_category": "balance",
                  "display_order": 3,
                  "status": "completed",
                  "completed_at": "2025-10-23T09:32:00Z",
                  "created_at": "2025-10-23T09:28:00Z",
                  "updated_at": "2025-10-23T09:32:00Z",
                  "metadata": {
                    "duration_seconds": 180,
                    "video_count": 1,
                    "test_side": "right",
                    "test_protocol": "Eyes Open Single Leg Stance"
                  },
                  "questions": [
                    {
                      "id": "q-bal-001",
                      "test_id": "test-single-leg-balance",
                      "question_text": "Maximum balance time achieved (seconds)",
                      "question_type": "duration",
                      "is_required": true,
                      "display_order": 1,
                      "help_text": "Record how long the client maintained single leg stance without touching down",
                      "validation_rules": {
                        "required": true,
                        "min_seconds": 0,
                        "max_seconds": 60
                      },
                      "metadata": {
                        "measurement_type": "endurance",
                        "test_side": "right"
                      },
                      "response": {
                        "id": "resp-bal-003",
                        "question_id": "q-bal-001",
                        "test_result_id": "tr-003-balance-right",
                        "response": 40,
                        "created_at": "2025-10-23T09:30:00Z",
                        "updated_at": "2025-10-23T09:30:00Z"
                      }
                    },
                    {
                      "id": "q-bal-002",
                      "test_id": "test-single-leg-balance",
                      "question_text": "Compensations observed",
                      "question_type": "multiselect",
                      "is_required": false,
                      "display_order": 2,
                      "help_text": "Select all compensatory movements observed during the test",
                      "options": [
                        {
                          "value": "hip_hike",
                          "label": "Hip hike"
                        },
                        {
                          "value": "trunk_lean",
                          "label": "Trunk lean"
                        },
                        {
                          "value": "arm_flailing",
                          "label": "Arm flailing"
                        },
                        {
                          "value": "excessive_sway",
                          "label": "Excessive sway"
                        },
                        {
                          "value": "foot_adjustment",
                          "label": "Foot adjustments"
                        },
                        {
                          "value": "none",
                          "label": "No compensations"
                        }
                      ],
                      "validation_rules": {
                        "min_selections": 0,
                        "max_selections": 6
                      },
                      "metadata": {
                        "assessment_type": "qualitative"
                      },
                      "response": {
                        "id": "resp-bal-004",
                        "question_id": "q-bal-002",
                        "test_result_id": "tr-003-balance-right",
                        "response": [
                          "none"
                        ],
                        "created_at": "2025-10-23T09:31:00Z",
                        "updated_at": "2025-10-23T09:31:00Z"
                      }
                    }
                  ],
                  "media_files": [
                    {
                      "id": "media-bal-002",
                      "test_result_id": "tr-003-balance-right",
                      "file_type": "video",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/balance-right.mp4",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/balance-right-thumb.jpg",
                      "file_size_bytes": 9437184,
                      "duration_seconds": 42,
                      "view_angle": "anterior",
                      "caption": "Single Leg Balance - Right Leg",
                      "created_at": "2025-10-23T09:29:00Z",
                      "metadata": {
                        "resolution": "1920x1080",
                        "fps": 30,
                        "codec": "h264"
                      }
                    }
                  ]
                },
                {
                  "id": "tr-004-shoulder-mob",
                  "assessment_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "test_id": "test-shoulder-mobility",
                  "test_name": "Shoulder Mobility Assessment",
                  "test_description": "Evaluates shoulder range of motion and mobility patterns",
                  "test_category": "mobility",
                  "display_order": 4,
                  "status": "completed",
                  "completed_at": "2025-10-23T09:42:00Z",
                  "created_at": "2025-10-23T09:35:00Z",
                  "updated_at": "2025-10-23T09:42:00Z",
                  "metadata": {
                    "duration_seconds": 240,
                    "video_count": 0,
                    "image_count": 1,
                    "test_protocol": "Shoulder Flexion ROM"
                  },
                  "questions": [
                    {
                      "id": "q-sh-001",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Shoulder flexion range of motion - Right (degrees)",
                      "question_type": "numeric",
                      "is_required": true,
                      "display_order": 1,
                      "help_text": "Measure active shoulder flexion using goniometer",
                      "validation_rules": {
                        "required": true,
                        "min": 0,
                        "max": 180,
                        "unit": "degrees"
                      },
                      "metadata": {
                        "body_region": "upper_body",
                        "movement_type": "flexion",
                        "test_side": "right"
                      },
                      "response": {
                        "id": "resp-sh-001",
                        "question_id": "q-sh-001",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": 145,
                        "created_at": "2025-10-23T09:38:00Z",
                        "updated_at": "2025-10-23T09:38:00Z"
                      }
                    },
                    {
                      "id": "q-sh-002",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Shoulder flexion range of motion - Left (degrees)",
                      "question_type": "numeric",
                      "is_required": true,
                      "display_order": 2,
                      "help_text": "Measure active shoulder flexion using goniometer",
                      "validation_rules": {
                        "required": true,
                        "min": 0,
                        "max": 180,
                        "unit": "degrees"
                      },
                      "metadata": {
                        "body_region": "upper_body",
                        "movement_type": "flexion",
                        "test_side": "left"
                      },
                      "response": {
                        "id": "resp-sh-002",
                        "question_id": "q-sh-002",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": 175,
                        "created_at": "2025-10-23T09:39:00Z",
                        "updated_at": "2025-10-23T09:39:00Z"
                      }
                    },
                    {
                      "id": "q-sh-003",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Pain level during movement",
                      "question_type": "scale_severity",
                      "is_required": true,
                      "display_order": 3,
                      "help_text": "Rate pain during shoulder flexion (0 = no pain, 10 = severe pain)",
                      "options": [
                        {
                          "value": 0,
                          "label": "No pain"
                        },
                        {
                          "value": 1,
                          "label": "Minimal"
                        },
                        {
                          "value": 2,
                          "label": "Minimal"
                        },
                        {
                          "value": 3,
                          "label": "Mild"
                        },
                        {
                          "value": 4,
                          "label": "Mild"
                        },
                        {
                          "value": 5,
                          "label": "Moderate"
                        },
                        {
                          "value": 6,
                          "label": "Moderate"
                        },
                        {
                          "value": 7,
                          "label": "Severe"
                        },
                        {
                          "value": 8,
                          "label": "Severe"
                        },
                        {
                          "value": 9,
                          "label": "Very severe"
                        },
                        {
                          "value": 10,
                          "label": "Worst possible"
                        }
                      ],
                      "validation_rules": {
                        "required": true,
                        "min": 0,
                        "max": 10
                      },
                      "metadata": {
                        "scale_type": "pain"
                      },
                      "response": {
                        "id": "resp-sh-003",
                        "question_id": "q-sh-003",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": 2,
                        "created_at": "2025-10-23T09:40:00Z",
                        "updated_at": "2025-10-23T09:40:00Z"
                      }
                    },
                    {
                      "id": "q-sh-004",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Quality of movement",
                      "question_type": "select",
                      "is_required": true,
                      "display_order": 4,
                      "help_text": "Assess the overall quality of the shoulder flexion movement",
                      "options": [
                        {
                          "value": "smooth",
                          "label": "Smooth and controlled"
                        },
                        {
                          "value": "hesitant",
                          "label": "Hesitant but controlled"
                        },
                        {
                          "value": "compensated",
                          "label": "Movement with compensations"
                        },
                        {
                          "value": "restricted",
                          "label": "Significantly restricted"
                        }
                      ],
                      "validation_rules": {
                        "required": true,
                        "enum": [
                          "smooth",
                          "hesitant",
                          "compensated",
                          "restricted"
                        ]
                      },
                      "metadata": {
                        "assessment_type": "qualitative"
                      },
                      "response": {
                        "id": "resp-sh-004",
                        "question_id": "q-sh-004",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": "compensated",
                        "created_at": "2025-10-23T09:41:00Z",
                        "updated_at": "2025-10-23T09:41:00Z"
                      }
                    },
                    {
                      "id": "q-sh-005",
                      "test_id": "test-shoulder-mobility",
                      "question_text": "Clinical notes",
                      "question_type": "textarea",
                      "is_required": false,
                      "display_order": 5,
                      "help_text": "Additional observations about shoulder mobility",
                      "validation_rules": {
                        "max_length": 1000
                      },
                      "metadata": {
                        "field_type": "notes"
                      },
                      "response": {
                        "id": "resp-sh-005",
                        "question_id": "q-sh-005",
                        "test_result_id": "tr-004-shoulder-mob",
                        "response": "Patient reports mild discomfort in right shoulder at end range. Notable scapular winging on right side. Recommend rotator cuff strengthening and scapular stabilization exercises.",
                        "created_at": "2025-10-23T09:42:00Z",
                        "updated_at": "2025-10-23T09:42:00Z"
                      }
                    }
                  ],
                  "media_files": [
                    {
                      "id": "media-sh-001",
                      "test_result_id": "tr-004-shoulder-mob",
                      "file_type": "image",
                      "file_url": "https://storage.example.com/assessments/a1b2c3d4/shoulder-rom-measurement.jpg",
                      "thumbnail_url": "https://storage.example.com/assessments/a1b2c3d4/shoulder-rom-measurement-thumb.jpg",
                      "file_size_bytes": 2097152,
                      "view_angle": "lateral",
                      "caption": "Goniometer measurement - Right shoulder flexion",
                      "created_at": "2025-10-23T09:38:30Z",
                      "metadata": {
                        "resolution": "3024x4032",
                        "format": "jpeg"
                      }
                    }
                  ]
                }
              ],
              "summary": {
                "total_tests": 4,
                "completed_tests": 4,
                "total_questions": 16,
                "answered_questions": 16,
                "total_media_files": 5,
                "bilateral_comparisons": [
                  {
                    "test_name": "Single Leg Balance Test",
                    "metric": "Balance Duration",
                    "left_value": 23,
                    "right_value": 40,
                    "unit": "seconds",
                    "difference": 17,
                    "percent_difference": "42.5%",
                    "interpretation": "Right leg shows significantly better balance. Consider left leg strengthening."
                  },
                  {
                    "test_name": "Shoulder Mobility Assessment",
                    "metric": "Shoulder Flexion ROM",
                    "left_value": 175,
                    "right_value": 145,
                    "unit": "degrees",
                    "difference": 30,
                    "percent_difference": "17.1%",
                    "interpretation": "Right shoulder shows limited ROM. Recommend mobility work and investigation of underlying causes."
                  }
                ],
                "key_findings": [
                  "Overhead squat shows mild knee valgus and limited ankle mobility",
                  "Significant bilateral balance deficit (42.5% difference) favoring right leg",
                  "Right shoulder mobility limited to 145Â° (normal: 170-180Â°)",
                  "Minimal pain reported during shoulder movement (2/10)",
                  "Multiple compensatory patterns observed during movement screening"
                ],
                "recommendations": [
                  "Ankle mobility exercises (calf stretching, dorsiflexion drills)",
                  "Hip and glute strengthening to address knee valgus",
                  "Left leg balance and stability work",
                  "Right shoulder mobility and rotator cuff strengthening",
                  "Scapular stabilization exercises",
                  "Follow-up assessment in 6-8 weeks to track progress"
                ]
              }
            },
            "meta": {
              "timestamp": "2025-10-23T09:45:00Z",
              "request_id": "req_1729674300_abc123",
              "version": "1.0.0"
            }
          },
          "webhookUrl": "https://fitwithparirp.app.n8n.cloud/webhook-test/ai-agents/create-profiles",
          "executionMode": "test"
        }
      }
    ]
  },
  "versionId": "258601e1-3c8a-468e-8578-6fbf329ab891",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-10-30T04:56:47.191Z",
      "updatedAt": "2025-10-30T04:56:47.191Z",
      "role": "workflow:owner",
      "workflowId": "WX5v9odm0AMjmDXS",
      "projectId": "nnULjHyqOVknXpmc"
    }
  ],
  "tags": []
}